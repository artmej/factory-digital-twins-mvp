# Factory Digital Twins MVP - Azure DevOps Pipeline
# VERSI√ìN CON ACI SELF-HOSTED AGENT

trigger:
  branches:
    include:
      - main

variables:
  resourceGroupName: 'factory-rg-dev'
  functionAppName: 'factory-func-adt-dev'

stages:
- stage: DeployInfrastructure
  displayName: 'Deploy Infrastructure with ACI Agent'
  pool:
    vmImage: 'ubuntu-latest'  # Use hosted agent for infrastructure
  jobs:
  - job: DeployInfra
    displayName: 'Deploy Bicep Template'
    steps:
    - task: AzureCLI@2
      displayName: 'Deploy Infrastructure with ACI'
      inputs:
        azureSubscription: 'factory-service-connection'
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          echo "üöÄ Deploying enhanced infrastructure with ACI agent..."
          az deployment group create \
            --resource-group $(resourceGroupName) \
            --template-file infra/bicep/main.bicep \
            --parameters environment=dev \
            --verbose
          echo "‚úÖ Infrastructure with ACI deployed successfully"
    
    - task: AzureCLI@2
      displayName: 'Configure ACI Agent Pool'
      inputs:
        azureSubscription: 'factory-service-connection'
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          echo "üîß Configuring agent pool..."
          
          # Create agent pool if it doesn't exist
          POOL_EXISTS=$(az pipelines pool list --query "[?name=='factory-agents'].name" -o tsv || echo "")
          
          if [ -z "$POOL_EXISTS" ]; then
            echo "üìù Creating agent pool: factory-agents"
            az pipelines pool create --name "factory-agents" --pool-type "SelfHosted"
          else
            echo "‚úÖ Agent pool 'factory-agents' already exists"
          fi
          
          echo "üîó Agent pool configured. ACI will connect automatically."

- stage: DeployApplication
  displayName: 'Deploy Application via ACI Agent'
  dependsOn: DeployInfrastructure
  condition: succeeded()
  pool:
    name: 'factory-agents'  # Use self-hosted agent in VNet
  jobs:
  - job: DeployApp
    displayName: 'Deploy Function App Code'
    steps:
    - task: NodeTool@0
      displayName: 'Setup Node.js'
      inputs:
        versionSpec: '18.x'
    
    - script: |
        cd src/function-adt-projection
        npm ci
        echo "‚úÖ Function app built successfully"
      displayName: 'Build Function App'
    
    - task: ArchiveFiles@2
      displayName: 'Archive Function App'
      inputs:
        rootFolderOrFile: 'src/function-adt-projection'
        includeRootFolder: false
        archiveType: 'zip'
        archiveFile: '$(Build.ArtifactStagingDirectory)/function-app.zip'
    
    - task: AzureFunctionApp@1
      displayName: 'Deploy Function App via Private Network'
      inputs:
        azureSubscription: 'factory-service-connection'
        appType: 'functionApp'
        appName: $(functionAppName)
        package: '$(Build.ArtifactStagingDirectory)/function-app.zip'
        deploymentMethod: 'zipDeploy'
    
    - script: |
        echo "üîç Validating deployment..."
        az functionapp show \
          --name $(functionAppName) \
          --resource-group $(resourceGroupName) \
          --query "state" -o tsv
        echo "‚úÖ Deployment successful - Function App accessible via VNet"
      displayName: 'Validate VNet Deployment'