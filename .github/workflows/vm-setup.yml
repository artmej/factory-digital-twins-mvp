name: ğŸ–¥ï¸ VM Edge Setup

on:
  workflow_run:
    workflows: ["ğŸš€ Azure Smart Factory Deploy"]
    types: [completed]
    branches: [main]
  workflow_dispatch:
    inputs:
      vm_ip:
        description: 'VM Public IP Address'
        required: true
      resource_group:
        description: 'Resource Group Name'
        required: true
        default: 'rg-smartfactory-prod'

jobs:
  # ğŸ”§ SETUP EDGE GATEWAY
  setup-edge:
    name: ğŸ–¥ï¸ Setup Edge Gateway
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Get VM Information
        id: vm-info
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VM_IP="${{ github.event.inputs.vm_ip }}"
            RG_NAME="${{ github.event.inputs.resource_group }}"
          else
            RG_NAME="rg-smartfactory-prod"
            VM_IP=$(az vm list-ip-addresses --resource-group $RG_NAME --query "[0].virtualMachine.network.publicIpAddresses[0].ipAddress" -o tsv)
          fi
          
          VM_NAME=$(az vm list --resource-group $RG_NAME --query "[0].name" -o tsv)
          
          echo "vm_ip=$VM_IP" >> $GITHUB_OUTPUT
          echo "vm_name=$VM_NAME" >> $GITHUB_OUTPUT
          echo "rg_name=$RG_NAME" >> $GITHUB_OUTPUT
          
          echo "ğŸ–¥ï¸ VM Info:"
          echo "- Name: $VM_NAME"
          echo "- IP: $VM_IP"
          echo "- Resource Group: $RG_NAME"

      - name: Install PowerShell Scripts on VM
        run: |
          # Create setup script for the VM
          cat > setup-edge-gateway.ps1 << 'EOF'
          # Smart Factory Edge Gateway Setup Script
          Write-Host "ğŸš€ Setting up Smart Factory Edge Gateway..." -ForegroundColor Green
          
          # Install Chocolatey
          Set-ExecutionPolicy Bypass -Scope Process -Force
          [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
          iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
          
          # Install Node.js, Git, and other tools
          choco install nodejs git vscode docker-desktop -y
          
          # Install Azure IoT Edge
          Write-Host "ğŸ“¡ Installing Azure IoT Edge..." -ForegroundColor Blue
          $progressPreference = 'silentlyContinue'
          Invoke-WebRequest "https://aka.ms/iotedge-win" -o "C:\iotedge-win.cab"
          Expand-Archive "C:\iotedge-win.cab" "C:\iotedge"
          Move-Item "C:\iotedge\*" "C:\iotedge" -Force
          
          # Create edge modules directory
          New-Item -ItemType Directory -Path "C:\SmartFactory" -Force
          New-Item -ItemType Directory -Path "C:\SmartFactory\modules" -Force
          New-Item -ItemType Directory -Path "C:\SmartFactory\data" -Force
          
          # Download Smart Factory modules
          Set-Location "C:\SmartFactory"
          git clone https://github.com/your-org/smart-factory-edge.git .
          
          Write-Host "âœ… Edge Gateway setup complete!" -ForegroundColor Green
          Write-Host "ğŸ“ Next steps:" -ForegroundColor Yellow
          Write-Host "  1. Configure IoT Edge connection string" -ForegroundColor White
          Write-Host "  2. Deploy edge modules" -ForegroundColor White
          Write-Host "  3. Start telemetry simulation" -ForegroundColor White
          EOF

          echo "ğŸ“„ Created setup script for VM"

      - name: Execute Setup via Azure Run Command
        run: |
          az vm run-command invoke \
            --resource-group ${{ steps.vm-info.outputs.rg_name }} \
            --name ${{ steps.vm-info.outputs.vm_name }} \
            --command-id RunPowerShellScript \
            --scripts @setup-edge-gateway.ps1

      - name: Configure IoT Edge Connection
        run: |
          # Get IoT Hub connection string
          IOT_HUB_NAME=$(az iot hub list --resource-group ${{ steps.vm-info.outputs.rg_name }} --query "[0].name" -o tsv)
          
          if [ ! -z "$IOT_HUB_NAME" ]; then
            # Register edge device
            DEVICE_ID="edge-gateway-vm"
            az iot hub device-identity create \
              --hub-name $IOT_HUB_NAME \
              --device-id $DEVICE_ID \
              --edge-enabled true \
              --output none || true
            
            # Get device connection string
            DEVICE_CONN_STRING=$(az iot hub device-identity connection-string show \
              --hub-name $IOT_HUB_NAME \
              --device-id $DEVICE_ID \
              --query "connectionString" -o tsv)
            
            echo "ğŸ”— Device registered: $DEVICE_ID"
            echo "ğŸ“¡ Connection string configured"
          fi

  # ğŸš€ DEPLOY EDGE MODULES
  deploy-modules:
    name: ğŸ“¦ Deploy Edge Modules
    runs-on: ubuntu-latest
    needs: setup-edge
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy Edge Deployment Manifest
        run: |
          IOT_HUB_NAME=$(az iot hub list --resource-group rg-smartfactory-prod --query "[0].name" -o tsv)
          DEVICE_ID="edge-gateway-vm"
          
          if [ ! -z "$IOT_HUB_NAME" ]; then
            # Deploy the edge deployment manifest
            az iot edge set-modules \
              --hub-name $IOT_HUB_NAME \
              --device-id $DEVICE_ID \
              --content edge/deployment.json
            
            echo "ğŸ“¦ Edge modules deployed successfully"
            echo "ğŸ¯ Modules:"
            echo "  - Device Simulator"
            echo "  - Telemetry Processor" 
            echo "  - Azure Functions Connector"
          fi

  # âœ… VERIFY DEPLOYMENT
  verify:
    name: âœ… Verify Edge Deployment
    runs-on: ubuntu-latest
    needs: deploy-modules
    
    steps:
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Check Edge Device Status
        run: |
          IOT_HUB_NAME=$(az iot hub list --resource-group rg-smartfactory-prod --query "[0].name" -o tsv)
          DEVICE_ID="edge-gateway-vm"
          
          if [ ! -z "$IOT_HUB_NAME" ]; then
            # Check device status
            STATUS=$(az iot hub device-identity show \
              --hub-name $IOT_HUB_NAME \
              --device-id $DEVICE_ID \
              --query "connectionState" -o tsv)
            
            echo "ğŸ–¥ï¸ Edge Device Status: $STATUS"
            
            # List running modules
            az iot hub module-identity list \
              --hub-name $IOT_HUB_NAME \
              --device-id $DEVICE_ID \
              --query "[].moduleId" -o table
            
            if [ "$STATUS" = "Connected" ]; then
              echo "âœ… Edge gateway is connected and ready!"
            else
              echo "âš ï¸ Edge gateway status: $STATUS"
            fi
          fi

      - name: Test Telemetry Flow
        run: |
          echo "ğŸ§ª Testing telemetry flow..."
          echo "ğŸ“Š Monitoring for 30 seconds..."
          
          # Monitor IoT Hub for incoming messages
          IOT_HUB_NAME=$(az iot hub list --resource-group rg-smartfactory-prod --query "[0].name" -o tsv)
          
          if [ ! -z "$IOT_HUB_NAME" ]; then
            timeout 30s az iot hub monitor-events \
              --hub-name $IOT_HUB_NAME \
              --device-id "edge-gateway-vm" || true
            
            echo "âœ… Telemetry test completed"
          fi