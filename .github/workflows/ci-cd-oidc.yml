name: Factory Digital Twins CI/CD (OIDC)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod

permissions:
  id-token: write
  contents: read

env:
  AZURE_RESOURCE_GROUP: factory-rg
  AZURE_LOCATION: eastus
  RESOURCE_PREFIX: factory
  NODE_VERSION: '18'

jobs:
  # ===== VALIDATE & TEST =====
  validate:
    runs-on: ubuntu-latest
    name: üîç Validate & Test
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4

    - name: üîß Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: |
          src/device-simulator/package-lock.json
          src/function-adt-projection/package-lock.json

    - name: üì¶ Install dependencies - Device Simulator
      working-directory: ./src/device-simulator
      run: npm ci

    - name: üì¶ Install dependencies - Function
      working-directory: ./src/function-adt-projection
      run: npm ci

    - name: üì¶ Install test dependencies
      working-directory: ./tests
      run: npm ci

    - name: üß™ Run unit tests
      working-directory: ./tests
      run: npm test

    - name: üîç Lint code
      run: |
        npx eslint src/device-simulator/simulator.js
        npx eslint src/function-adt-projection/index.js

    - name: ‚úÖ Validate Bicep templates
      uses: azure/CLI@v1
      with:
        inlineScript: |
          az bicep build --file ./infra/bicep/main.bicep

    - name: üèóÔ∏è Validate DTDL models
      run: |
        for file in models/*.dtdl.json; do
          echo "Validating $file"
          jq empty "$file"
        done

  # ===== BUILD =====
  build:
    runs-on: ubuntu-latest
    needs: validate
    name: üèóÔ∏è Build Artifacts
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4

    - name: üîß Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: üèóÔ∏è Build Function App
      working-directory: ./src/function-adt-projection
      run: |
        npm ci --production
        zip -r ../../function-app.zip . -x "node_modules/.cache/*" "*.log"

    - name: üèóÔ∏è Build Device Simulator
      working-directory: ./src/device-simulator
      run: |
        npm ci --production
        zip -r ../../device-simulator.zip . -x "node_modules/.cache/*" "*.log"

    - name: üì§ Upload Function artifact
      uses: actions/upload-artifact@v4
      with:
        name: function-app
        path: function-app.zip
        retention-days: 30

    - name: üì§ Upload Simulator artifact
      uses: actions/upload-artifact@v4
      with:
        name: device-simulator
        path: device-simulator.zip
        retention-days: 30

  # ===== DEPLOY DEV =====
  deploy-dev:
    if: github.ref == 'refs/heads/develop' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'dev')
    runs-on: ubuntu-latest
    needs: build
    environment: dev
    name: üöÄ Deploy to DEV
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4

    - name: üîê Azure Login (OIDC)
      uses: azure/login@v1
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

    - name: üèóÔ∏è Deploy Infrastructure
      uses: azure/CLI@v1
      with:
        inlineScript: |
          # Create resource group if it doesn't exist
          az group create --name ${{ env.AZURE_RESOURCE_GROUP }}-dev --location ${{ env.AZURE_LOCATION }}
          
          # Deploy Bicep template
          az deployment group create \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }}-dev \
            --template-file ./infra/bicep/main.bicep \
            --parameters location=${{ env.AZURE_LOCATION }} \
                        resourcePrefix=${{ env.RESOURCE_PREFIX }} \
                        environment=dev

    - name: üìä Setup Digital Twins Models
      uses: azure/CLI@v1
      with:
        inlineScript: |
          # Upload DTDL models
          ADT_NAME="${{ env.RESOURCE_PREFIX }}-adt-dev"
          
          for model in models/*.dtdl.json; do
            echo "Uploading model: $model"
            az dt model create --dt-name $ADT_NAME --models @"$model"
          done

    - name: üì• Download Function artifact
      uses: actions/download-artifact@v4
      with:
        name: function-app

    - name: üöÄ Deploy Function App
      uses: azure/CLI@v1
      with:
        inlineScript: |
          FUNC_NAME="${{ env.RESOURCE_PREFIX }}-func-dev"
          
          # Deploy function code
          az functionapp deployment source config-zip \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }}-dev \
            --name $FUNC_NAME \
            --src function-app.zip

    - name: ‚öôÔ∏è Configure Function Settings
      uses: azure/CLI@v1
      with:
        inlineScript: |
          FUNC_NAME="${{ env.RESOURCE_PREFIX }}-func-dev"
          ADT_NAME="${{ env.RESOURCE_PREFIX }}-adt-dev"
          
          # Get Digital Twins URL
          ADT_URL=$(az dt show --dt-name $ADT_NAME --query hostName -o tsv)
          
          # Configure function app settings
          az functionapp config appsettings set \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }}-dev \
            --name $FUNC_NAME \
            --settings DIGITAL_TWINS_URL="https://$ADT_URL"

    - name: üß™ Run Integration Tests
      uses: azure/CLI@v1
      with:
        inlineScript: |
          # Run integration tests against deployed environment
          export AZURE_RESOURCE_GROUP="${{ env.AZURE_RESOURCE_GROUP }}-dev"
          export RESOURCE_PREFIX="${{ env.RESOURCE_PREFIX }}"
          export ENVIRONMENT="dev"
          
          # Set up Digital Twins URL for testing
          ADT_NAME="${{ env.RESOURCE_PREFIX }}-adt-dev"
          ADT_URL=$(az dt show --dt-name $ADT_NAME --query hostName -o tsv)
          export DIGITAL_TWINS_URL="https://$ADT_URL"
          
          # Execute integration tests
          cd tests/integration
          npm ci
          npm test

  # ===== DEPLOY STAGING =====
  deploy-staging:
    if: github.ref == 'refs/heads/main' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging')
    runs-on: ubuntu-latest
    needs: [build, deploy-dev]
    environment: staging
    name: üéØ Deploy to STAGING
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4

    - name: üîê Azure Login (OIDC)
      uses: azure/login@v1
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

    - name: üèóÔ∏è Deploy Infrastructure
      uses: azure/CLI@v1
      with:
        inlineScript: |
          az group create --name ${{ env.AZURE_RESOURCE_GROUP }}-staging --location ${{ env.AZURE_LOCATION }}
          
          az deployment group create \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }}-staging \
            --template-file ./infra/bicep/main.bicep \
            --parameters location=${{ env.AZURE_LOCATION }} \
                        resourcePrefix=${{ env.RESOURCE_PREFIX }} \
                        environment=staging

    - name: üìä Setup Digital Twins Models
      uses: azure/CLI@v1
      with:
        inlineScript: |
          ADT_NAME="${{ env.RESOURCE_PREFIX }}-adt-staging"
          for model in models/*.dtdl.json; do
            az dt model create --dt-name $ADT_NAME --models @"$model"
          done

  # ===== DEPLOY PRODUCTION =====
  deploy-prod:
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'prod'
    runs-on: ubuntu-latest
    needs: [build, deploy-staging]
    environment: production
    name: üè≠ Deploy to PRODUCTION
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4

    - name: üîê Azure Login (OIDC)
      uses: azure/login@v1
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

    - name: üèóÔ∏è Deploy Infrastructure
      uses: azure/CLI@v1
      with:
        inlineScript: |
          az group create --name ${{ env.AZURE_RESOURCE_GROUP }}-prod --location ${{ env.AZURE_LOCATION }}
          
          az deployment group create \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }}-prod \
            --template-file ./infra/bicep/main.bicep \
            --parameters location=${{ env.AZURE_LOCATION }} \
                        resourcePrefix=${{ env.RESOURCE_PREFIX }} \
                        environment=prod

    - name: üìä Setup Digital Twins Models
      uses: azure/CLI@v1
      with:
        inlineScript: |
          ADT_NAME="${{ env.RESOURCE_PREFIX }}-adt-prod"
          for model in models/*.dtdl.json; do
            az dt model create --dt-name $ADT_NAME --models @"$model"
          done