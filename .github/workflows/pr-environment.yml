name: Pull Request Environment

on:
  pull_request:
    branches: [ main, develop ]
    types: [ opened, synchronize, reopened ]

permissions:
  id-token: write
  contents: read
  pull-requests: write

env:
  AZURE_LOCATION: eastus
  RESOURCE_PREFIX: factory
  NODE_VERSION: '18'

jobs:
  deploy-pr-environment:
    runs-on: ubuntu-latest
    name: üîß Deploy PR Environment
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4

    - name: üîê Azure Login (OIDC)
      uses: azure/login@v1
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

    - name: üèóÔ∏è Deploy PR Infrastructure
      uses: azure/CLI@v1
      with:
        inlineScript: |
          PR_RG="factory-rg-pr-${{ github.event.number }}"
          
          # Create unique resource group for PR
          az group create --name $PR_RG --location ${{ env.AZURE_LOCATION }}
          
          # Deploy with PR-specific naming
          az deployment group create \
            --resource-group $PR_RG \
            --template-file ./infra/bicep/main.bicep \
            --parameters location=${{ env.AZURE_LOCATION }} \
                        resourcePrefix="${{ env.RESOURCE_PREFIX }}-pr${{ github.event.number }}" \
                        environment=pr

    - name: üìä Setup Digital Twins Models
      uses: azure/CLI@v1
      with:
        inlineScript: |
          ADT_NAME="${{ env.RESOURCE_PREFIX }}-pr${{ github.event.number }}-adt-pr"
          for model in models/*.dtdl.json; do
            az dt model create --dt-name $ADT_NAME --models @"$model"
          done

    - name: üìù Comment PR with Environment Info
      uses: actions/github-script@v7
      with:
        script: |
          const prNumber = context.payload.number;
          const comment = `## üöÄ PR Environment Deployed
          
          **Environment**: PR-${prNumber}
          **Resource Group**: factory-rg-pr-${prNumber}
          **Digital Twins**: factory-pr${prNumber}-adt-pr
          **IoT Hub**: factory-pr${prNumber}-iothub-pr
          **Function App**: factory-pr${prNumber}-func-pr
          
          ### üß™ Test URLs
          - Function App: https://factory-pr${prNumber}-func-pr.azurewebsites.net
          - Digital Twins Explorer: [Open in Portal](https://portal.azure.com/#@/resource/subscriptions/${{ secrets.AZURE_SUBSCRIPTION_ID }}/resourceGroups/factory-rg-pr-${prNumber}/providers/Microsoft.DigitalTwins/digitalTwinsInstances/factory-pr${prNumber}-adt-pr/overview)
          
          ### ‚ö†Ô∏è Important
          This environment will be automatically deleted when the PR is closed.
          `;
          
          github.rest.issues.createComment({
            issue_number: prNumber,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });