name: Factory Digital Twins CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod

permissions:
  id-token: write
  contents: read

env:
  AZURE_RESOURCE_GROUP: factory-rg
  AZURE_LOCATION: eastus
  RESOURCE_PREFIX: factory
  NODE_VERSION: '18'

jobs:
  # ===== VALIDATE & TEST =====
  validate:
    runs-on: ubuntu-latest
    name: üîç Validate & Test
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4

    - name: üîß Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: üì¶ Install dependencies - Device Simulator
      working-directory: ./src/device-simulator
      run: npm ci

    - name: üì¶ Install dependencies - Function
      working-directory: ./src/function-adt-projection
      run: npm ci

    - name: üß™ Run unit tests
      working-directory: ./tests
      run: npm test
        
    - name: üîç Lint code
      run: |
        npx eslint src/device-simulator/simulator.js
        npx eslint src/function-adt-projection/index.js

    - name: ‚úÖ Validate Bicep templates
      uses: azure/CLI@v1
      with:
        inlineScript: |
          az bicep build --file ./infra/bicep/main.bicep

    - name: üèóÔ∏è Validate DTDL models
      run: |
        # Install dtdl-validator (if available) or basic JSON validation
        for file in models/*.dtdl.json; do
          echo "Validating $file"
          jq empty "$file" # Basic JSON validation
        done

  # ===== BUILD =====
  build:
    runs-on: ubuntu-latest
    needs: validate
    name: üèóÔ∏è Build Artifacts
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4

    - name: üîß Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: üèóÔ∏è Build Function App
      working-directory: ./src/function-adt-projection
      run: |
        npm ci --production
        zip -r ../../function-app.zip . -x "node_modules/.cache/*" "*.log"

    - name: üèóÔ∏è Build Device Simulator
      working-directory: ./src/device-simulator
      run: |
        npm ci --production
        zip -r ../../device-simulator.zip . -x "node_modules/.cache/*" "*.log"

    - name: üì§ Upload Function artifact
      uses: actions/upload-artifact@v4
      with:
        name: function-app
        path: function-app.zip
        retention-days: 30

    - name: üì§ Upload Simulator artifact
      uses: actions/upload-artifact@v4
      with:
        name: device-simulator
        path: device-simulator.zip
        retention-days: 30

  # ===== DEPLOY DEV =====
  deploy-dev:
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'dev')
    runs-on: ubuntu-latest
    needs: build
    environment: dev
    name: üöÄ Deploy to DEV
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4

    - name: üîê Azure Login
      uses: azure/login@v1
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

    - name: üèóÔ∏è Deploy Infrastructure
      uses: azure/CLI@v1
      with:
        inlineScript: |
          # Create resource group if it doesn't exist
          az group create --name ${{ env.AZURE_RESOURCE_GROUP }}-dev --location ${{ env.AZURE_LOCATION }}
          
          # Deploy Bicep template
          az deployment group create \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }}-dev \
            --template-file ./infra/bicep/main.bicep \
            --parameters location=${{ env.AZURE_LOCATION }} \
                        resourcePrefix=${{ env.RESOURCE_PREFIX }} \
                        environment=dev

    - name: üîê Grant Pipeline Permissions to Digital Twins
      uses: azure/CLI@v1
      with:
        inlineScript: |
          ADT_NAME="${{ env.RESOURCE_PREFIX }}-adt-dev"
          
          # Get current pipeline principal ID
          PIPELINE_PRINCIPAL_ID=$(az account show --query user.name -o tsv)
          
          # Grant Azure Digital Twins Data Owner role to pipeline
          az role assignment create \
            --role "Azure Digital Twins Data Owner" \
            --assignee $PIPELINE_PRINCIPAL_ID \
            --scope "/subscriptions/$(az account show --query id -o tsv)/resourceGroups/${{ env.AZURE_RESOURCE_GROUP }}-dev/providers/Microsoft.DigitalTwins/digitalTwinsInstances/$ADT_NAME"

    - name: üìä Setup Digital Twins Models
      uses: azure/CLI@v1
      with:
        inlineScript: |
          # Upload DTDL models with error handling
          ADT_NAME="${{ env.RESOURCE_PREFIX }}-adt-dev"
          
          for model in models/*.dtdl.json; do
            echo "Processing model: $model"
            
            # Try to create the model, ignore if it already exists
            if az dt model create --dt-name $ADT_NAME --models @"$model" 2>/dev/null; then
              echo "‚úÖ Successfully uploaded model: $model"
            else
              echo "‚ö†Ô∏è  Model already exists or failed to upload: $model - continuing..."
            fi
          done
          
          echo "üìã Current models in Digital Twins instance:"
          az dt model list --dt-name $ADT_NAME --query "[].id" -o table

    - name: üì• Download Function artifact
      uses: actions/download-artifact@v4
      with:
        name: function-app

    - name: üîç Validate Storage Access
      uses: azure/CLI@v1
      with:
        inlineScript: |
          # Get storage account name
          STORAGE_ACCOUNT=$(az storage account list \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }}-dev \
            --query "[0].name" -o tsv)
          
          echo "üîç Checking storage account network rules..."
          az storage account show --name $STORAGE_ACCOUNT --resource-group ${{ env.AZURE_RESOURCE_GROUP }}-dev --query "networkRuleSet.{defaultAction:defaultAction,bypass:bypass}" -o table
          
          echo "üåê Current external IP for GitHub Actions:"
          curl -s https://ifconfig.me/ip || echo "Could not determine IP"

    - name: üöÄ Deploy Function App  
      uses: azure/CLI@v1
      with:
        inlineScript: |
          FUNC_NAME="${{ env.RESOURCE_PREFIX }}-func-adt-dev"
          
          echo "üöÄ Deploying function code to $FUNC_NAME using run-from-package method..."
          
          # Get storage account name
          STORAGE_ACCOUNT=$(az storage account list \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }}-dev \
            --query "[0].name" -o tsv)
          
          echo "üì¶ Using storage account: $STORAGE_ACCOUNT"
          
          # Temporarily allow access from VNet
          echo "üîì Temporarily allowing VNet access to storage account..."
          
          # Add VNet subnet to storage account network rules
          VNET_NAME="${{ env.RESOURCE_PREFIX }}-vnet-dev"
          SUBNET_NAME="default"
          
          echo "Adding VNet access: $VNET_NAME/$SUBNET_NAME"
          az storage account network-rule add \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }}-dev \
            --account-name $STORAGE_ACCOUNT \
            --vnet-name $VNET_NAME \
            --subnet $SUBNET_NAME || echo "VNet rule may already exist"
          
          # Also temporarily enable additional Azure services
          echo "üîì Enabling Azure services bypass..."
          az storage account update \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }}-dev \
            --name $STORAGE_ACCOUNT \
            --bypass "AzureServices Metrics Logging"
          
          # Wait for network rule to take effect
          echo "‚è±Ô∏è  Waiting for network rules to propagate..."
          sleep 15
          
          # Use Azure RBAC instead of keys (organizationally required)
          echo "üîê Using Azure RBAC authentication for storage operations..."
          
          # Create container for function packages
          CONTAINER_NAME="function-releases"
          BLOB_NAME="function-app-$(date +%Y%m%d-%H%M%S).zip"
          
          echo "üìÇ Creating container: $CONTAINER_NAME"
          az storage container create \
            --name $CONTAINER_NAME \
            --account-name $STORAGE_ACCOUNT \
            --auth-mode login \
            --public-access off || echo "Container may already exist"
          
          # Upload function package using RBAC
          echo "‚¨ÜÔ∏è  Uploading function package: $BLOB_NAME"
          az storage blob upload \
            --file function-app.zip \
            --name $BLOB_NAME \
            --container-name $CONTAINER_NAME \
            --account-name $STORAGE_ACCOUNT \
            --auth-mode login \
            --overwrite
          
          # Generate SAS URL using RBAC (valid for 1 year) 
          EXPIRY=$(date -u -d "1 year" +"%Y-%m-%dT%H:%MZ")
          PACKAGE_URL=$(az storage blob generate-sas \
            --account-name $STORAGE_ACCOUNT \
            --container-name $CONTAINER_NAME \
            --name $BLOB_NAME \
            --permissions r \
            --expiry $EXPIRY \
            --auth-mode login \
            --as-user \
            --full-uri -o tsv)
          
          echo "üîó Package URL generated: ${PACKAGE_URL:0:50}..."
          
          # Configure Function App to run from package
          echo "‚öôÔ∏è  Configuring WEBSITE_RUN_FROM_PACKAGE setting..."
          az functionapp config appsettings set \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }}-dev \
            --name $FUNC_NAME \
            --settings WEBSITE_RUN_FROM_PACKAGE="$PACKAGE_URL"
          
          # Clean up - remove VNet access and restore original bypass settings
          echo "üîí Restoring storage network rules to original state..."
          az storage account network-rule remove \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }}-dev \
            --account-name $STORAGE_ACCOUNT \
            --vnet-name $VNET_NAME \
            --subnet $SUBNET_NAME || echo "VNet rule removal failed or already removed"
          
          # Restore original bypass settings
          az storage account update \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }}-dev \
            --name $STORAGE_ACCOUNT \
            --bypass AzureServices || echo "Bypass update failed"
          
          echo "‚úÖ Function App deployment completed using run-from-package!"

    - name: ‚öôÔ∏è Configure Function Settings
      uses: azure/CLI@v1
      with:
        inlineScript: |
          FUNC_NAME="${{ env.RESOURCE_PREFIX }}-func-adt-dev"
          ADT_NAME="${{ env.RESOURCE_PREFIX }}-adt-dev"
          
          # Get Digital Twins URL
          ADT_URL=$(az dt show --dt-name $ADT_NAME --query hostName -o tsv)
          
          # Configure function app settings
          az functionapp config appsettings set \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }}-dev \
            --name $FUNC_NAME \
            --settings DIGITAL_TWINS_URL="https://$ADT_URL"

    - name: üß™ Run Integration Tests
      uses: azure/CLI@v1
      with:
        inlineScript: |
          # Run integration tests against deployed environment
          export AZURE_RESOURCE_GROUP="${{ env.AZURE_RESOURCE_GROUP }}-dev"
          export RESOURCE_PREFIX="${{ env.RESOURCE_PREFIX }}"
          export ENVIRONMENT="dev"
          
          # Execute integration tests
          cd tests/integration
          npm ci
          npm test

  # ===== DEPLOY STAGING =====
  deploy-staging:
    if: false # Disabled for now - using DEV for main branch
    runs-on: ubuntu-latest
    needs: build
    environment: staging
    name: üéØ Deploy to STAGING
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4

    - name: üîê Azure Login
      uses: azure/login@v1
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

    - name: üèóÔ∏è Deploy Infrastructure
      uses: azure/CLI@v1
      with:
        inlineScript: |
          az group create --name ${{ env.AZURE_RESOURCE_GROUP }}-staging --location ${{ env.AZURE_LOCATION }}
          
          az deployment group create \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }}-staging \
            --template-file ./infra/bicep/main.bicep \
            --parameters location=${{ env.AZURE_LOCATION }} \
                        resourcePrefix=${{ env.RESOURCE_PREFIX }} \
                        environment=staging

    # Similar steps as dev but for staging environment
    - name: üìä Setup Digital Twins Models
      uses: azure/CLI@v1
      with:
        inlineScript: |
          ADT_NAME="${{ env.RESOURCE_PREFIX }}-adt-staging"
          for model in models/*.dtdl.json; do
            az dt model create --dt-name $ADT_NAME --models @"$model"
          done

  # ===== DEPLOY PRODUCTION =====
  deploy-prod:
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'prod'
    runs-on: ubuntu-latest
    needs: [build, deploy-staging]
    environment: production
    name: üè≠ Deploy to PRODUCTION
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4

    - name: üîê Azure Login
      uses: azure/login@v1
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

    - name: üèóÔ∏è Deploy Infrastructure
      uses: azure/CLI@v1
      with:
        inlineScript: |
          az group create --name ${{ env.AZURE_RESOURCE_GROUP }}-prod --location ${{ env.AZURE_LOCATION }}
          
          az deployment group create \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }}-prod \
            --template-file ./infra/bicep/main.bicep \
            --parameters location=${{ env.AZURE_LOCATION }} \
                        resourcePrefix=${{ env.RESOURCE_PREFIX }} \
                        environment=prod

    - name: üìä Setup Digital Twins Models
      uses: azure/CLI@v1
      with:
        inlineScript: |
          ADT_NAME="${{ env.RESOURCE_PREFIX }}-adt-prod"
          for model in models/*.dtdl.json; do
            az dt model create --dt-name $ADT_NAME --models @"$model"
          done

  # ===== CLEANUP =====
  cleanup-dev:
    if: github.event_name == 'pull_request' && github.event.action == 'closed'
    runs-on: ubuntu-latest
    name: üßπ Cleanup DEV (PR closed)
    
    steps:
    - name: üîê Azure Login
      uses: azure/login@v1
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

    - name: üóëÔ∏è Delete PR environment
      uses: azure/CLI@v1
      with:
        inlineScript: |
          PR_RG="factory-rg-pr-${{ github.event.number }}"
          if az group exists --name $PR_RG; then
            echo "Deleting resource group: $PR_RG"
            az group delete --name $PR_RG --yes --no-wait
          fi