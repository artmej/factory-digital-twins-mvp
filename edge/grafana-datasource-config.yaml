apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-datasource
  namespace: arc
data:
  datasource.yml: |
    apiVersion: 1
    datasources:
    - name: SmartFactoryDB
      type: postgres
      url: postgres-smartfactory:5432
      database: smartfactory
      user: sfadmin
      secureJsonData:
        password: SmartFactory2024!
      access: proxy
      isDefault: true
      jsonData:
        sslmode: disable
        postgresVersion: 15
        timescaledb: true
      readOnly: false
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboards-config
  namespace: arc
data:
  dashboard.yml: |
    apiVersion: 1
    providers:
    - name: 'default'
      orgId: 1
      folder: ''
      type: file
      disableDeletion: false
      updateIntervalSeconds: 10
      allowUiUpdates: true
      options:
        path: /var/lib/grafana/dashboards
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: smartfactory-dashboard
  namespace: arc
data:
  smartfactory.json: |
    {
      "dashboard": {
        "id": null,
        "title": "ðŸ­ Smart Factory Monitor",
        "tags": ["smart-factory", "iot", "digital-twins"],
        "timezone": "browser",
        "panels": [
          {
            "id": 1,
            "title": "ðŸ­ Factory Efficiency",
            "type": "stat",
            "targets": [
              {
                "expr": "",
                "rawSql": "SELECT timestamp as time, value FROM sensor_data WHERE sensor_id = 'factory-main' ORDER BY timestamp DESC LIMIT 1",
                "format": "table",
                "datasource": {"type": "postgres", "uid": "smartfactory"}
              }
            ],
            "fieldConfig": {
              "defaults": {
                "color": {"mode": "thresholds"},
                "thresholds": {
                  "steps": [
                    {"color": "red", "value": 0},
                    {"color": "yellow", "value": 70},
                    {"color": "green", "value": 85}
                  ]
                },
                "unit": "percent"
              }
            },
            "gridPos": {"h": 8, "w": 6, "x": 0, "y": 0}
          },
          {
            "id": 2,
            "title": "ðŸ”§ Line Performance",
            "type": "stat",
            "targets": [
              {
                "rawSql": "SELECT timestamp as time, value FROM sensor_data WHERE sensor_id = 'line1-main' ORDER BY timestamp DESC LIMIT 1",
                "format": "table",
                "datasource": {"type": "postgres", "uid": "smartfactory"}
              }
            ],
            "fieldConfig": {
              "defaults": {
                "color": {"mode": "thresholds"},
                "thresholds": {
                  "steps": [
                    {"color": "red", "value": 0},
                    {"color": "yellow", "value": 75},
                    {"color": "green", "value": 90}
                  ]
                },
                "unit": "percent"
              }
            },
            "gridPos": {"h": 8, "w": 6, "x": 6, "y": 0}
          },
          {
            "id": 3,
            "title": "ðŸŒ¡ï¸ Machine Temperature",
            "type": "stat",
            "targets": [
              {
                "rawSql": "SELECT timestamp as time, value FROM sensor_data WHERE sensor_id = 'machine1' ORDER BY timestamp DESC LIMIT 1",
                "format": "table",
                "datasource": {"type": "postgres", "uid": "smartfactory"}
              }
            ],
            "fieldConfig": {
              "defaults": {
                "color": {"mode": "thresholds"},
                "thresholds": {
                  "steps": [
                    {"color": "green", "value": 0},
                    {"color": "yellow", "value": 40},
                    {"color": "red", "value": 60}
                  ]
                },
                "unit": "celsius"
              }
            },
            "gridPos": {"h": 8, "w": 6, "x": 12, "y": 0}
          },
          {
            "id": 4,
            "title": "ðŸ“ˆ Real-time Trends",
            "type": "timeseries",
            "targets": [
              {
                "rawSql": "SELECT timestamp as time, sensor_id as metric, value FROM sensor_data WHERE timestamp > NOW() - INTERVAL '1 hour' ORDER BY timestamp",
                "format": "table",
                "datasource": {"type": "postgres", "uid": "smartfactory"}
              }
            ],
            "fieldConfig": {
              "defaults": {
                "color": {"mode": "palette-classic"}
              }
            },
            "gridPos": {"h": 8, "w": 24, "x": 0, "y": 8}
          },
          {
            "id": 5,
            "title": "ðŸ“Š Data Volume (Last Hour)",
            "type": "table",
            "targets": [
              {
                "rawSql": "SELECT sensor_id as \"Sensor\", COUNT(*) as \"Records\", AVG(value)::numeric(10,2) as \"Avg Value\", MIN(value)::numeric(10,2) as \"Min\", MAX(value)::numeric(10,2) as \"Max\" FROM sensor_data WHERE timestamp > NOW() - INTERVAL '1 hour' GROUP BY sensor_id ORDER BY sensor_id",
                "format": "table",
                "datasource": {"type": "postgres", "uid": "smartfactory"}
              }
            ],
            "gridPos": {"h": 8, "w": 12, "x": 0, "y": 16}
          },
          {
            "id": 6,
            "title": "âš¡ System Health",
            "type": "stat",
            "targets": [
              {
                "rawSql": "SELECT COUNT(DISTINCT sensor_id) as active_sensors FROM sensor_data WHERE timestamp > NOW() - INTERVAL '5 minutes'",
                "format": "table",
                "datasource": {"type": "postgres", "uid": "smartfactory"}
              }
            ],
            "fieldConfig": {
              "defaults": {
                "color": {"mode": "thresholds"},
                "thresholds": {
                  "steps": [
                    {"color": "red", "value": 0},
                    {"color": "yellow", "value": 1},
                    {"color": "green", "value": 3}
                  ]
                },
                "unit": "short"
              }
            },
            "gridPos": {"h": 8, "w": 12, "x": 12, "y": 16}
          }
        ],
        "time": {
          "from": "now-1h",
          "to": "now"
        },
        "refresh": "5s",
        "schemaVersion": 30,
        "version": 0
      }
    }