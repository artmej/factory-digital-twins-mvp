// üö® Smart Factory Anomaly Generator - End-to-End Testing\n// Comprehensive anomaly simulation for complete system demonstration\n\nclass SmartFactoryAnomalyGenerator {\n    constructor() {\n        this.name = \"Smart Factory Anomaly Generator\";\n        this.isActive = false;\n        this.activeAnomalies = new Map();\n        this.anomalyQueue = [];\n        this.impactTracker = new Map();\n        \n        // üè≠ Factory simulation endpoints\n        this.endpoints = {\n            iot_sensors: '/api/iot/sensors/inject-anomaly',\n            azure_digital_twins: '/api/dt/update-anomaly',\n            ml_models: '/api/ml/anomaly-detected',\n            health_modeling: '/api/health/anomaly-impact',\n            dashboard: '/api/dashboard/anomaly-alert',\n            notifications: '/api/notifications/anomaly'\n        };\n        \n        // üéØ Anomaly types with realistic industrial scenarios\n        this.anomalyTypes = {\n            mechanical_failure: {\n                name: 'Mechanical Failure',\n                description: 'Bearing degradation in CNC machine',\n                severity: 'critical',\n                machine_types: ['CNC', 'LATHE', 'MILL'],\n                duration: { min: 30, max: 180 }, // minutes\n                symptoms: {\n                    vibration: { increase: 300, unit: '%' },\n                    temperature: { increase: 15, unit: 'C' },\n                    power_consumption: { increase: 25, unit: '%' },\n                    quality_score: { decrease: 40, unit: '%' },\n                    efficiency: { decrease: 60, unit: '%' }\n                },\n                propagation_time: 5000, // 5 seconds\n                cost_impact: 25000, // USD per hour\n                maintenance_required: true\n            },\n            \n            thermal_overload: {\n                name: 'Thermal Overload',\n                description: 'Cooling system failure causing overheating',\n                severity: 'warning',\n                machine_types: ['ALL'],\n                duration: { min: 15, max: 60 },\n                symptoms: {\n                    temperature: { increase: 25, unit: 'C' },\n                    power_consumption: { increase: 15, unit: '%' },\n                    efficiency: { decrease: 20, unit: '%' },\n                    health_score: { decrease: 30, unit: '%' }\n                },\n                propagation_time: 3000, // 3 seconds\n                cost_impact: 8000, // USD per hour\n                maintenance_required: false\n            },\n            \n            quality_degradation: {\n                name: 'Quality Degradation',\n                description: 'Gradual decline in production quality',\n                severity: 'warning',\n                machine_types: ['ASSEMBLY', 'QUALITY_CONTROL'],\n                duration: { min: 45, max: 240 },\n                symptoms: {\n                    quality_score: { decrease: 25, unit: '%' },\n                    defect_rate: { increase: 150, unit: '%' },\n                    efficiency: { decrease: 15, unit: '%' },\n                    customer_satisfaction: { decrease: 10, unit: '%' }\n                },\n                propagation_time: 8000, // 8 seconds\n                cost_impact: 12000, // USD per hour\n                maintenance_required: true\n            },\n            \n            power_anomaly: {\n                name: 'Power System Anomaly',\n                description: 'Electrical instability affecting multiple machines',\n                severity: 'critical',\n                machine_types: ['ALL'],\n                duration: { min: 5, max: 30 },\n                symptoms: {\n                    power_consumption: { fluctuation: 40, unit: '%' },\n                    voltage: { decrease: 8, unit: '%' },\n                    frequency: { fluctuation: 2, unit: 'Hz' },\n                    efficiency: { decrease: 35, unit: '%' },\n                    health_score: { decrease: 45, unit: '%' }\n                },\n                propagation_time: 1000, // 1 second\n                cost_impact: 50000, // USD per hour\n                maintenance_required: true\n            },\n            \n            network_disruption: {\n                name: 'Network Connectivity Issue',\n                description: 'IoT communication degradation',\n                severity: 'warning',\n                machine_types: ['ALL'],\n                duration: { min: 10, max: 45 },\n                symptoms: {\n                    data_latency: { increase: 500, unit: '%' },\n                    packet_loss: { increase: 25, unit: '%' },\n                    connectivity_score: { decrease: 60, unit: '%' },\n                    real_time_monitoring: { decrease: 80, unit: '%' }\n                },\n                propagation_time: 2000, // 2 seconds\n                cost_impact: 5000, // USD per hour\n                maintenance_required: false\n            },\n            \n            supply_chain_disruption: {\n                name: 'Supply Chain Disruption',\n                description: 'Raw material quality issues affecting production',\n                severity: 'warning',\n                machine_types: ['ASSEMBLY', 'PACKAGING'],\n                duration: { min: 120, max: 480 },\n                symptoms: {\n                    quality_score: { decrease: 35, unit: '%' },\n                    defect_rate: { increase: 200, unit: '%' },\n                    production_rate: { decrease: 25, unit: '%' },\n                    inventory_efficiency: { decrease: 40, unit: '%' }\n                },\n                propagation_time: 15000, // 15 seconds\n                cost_impact: 15000, // USD per hour\n                maintenance_required: false\n            },\n            \n            cybersecurity_incident: {\n                name: 'Cybersecurity Incident',\n                description: 'Suspicious network activity detected',\n                severity: 'critical',\n                machine_types: ['ALL'],\n                duration: { min: 1, max: 10 },\n                symptoms: {\n                    security_score: { decrease: 70, unit: '%' },\n                    network_traffic: { increase: 300, unit: '%' },\n                    unauthorized_access: { increase: 1000, unit: '%' },\n                    system_lockdown: { activate: true }\n                },\n                propagation_time: 500, // 0.5 seconds\n                cost_impact: 100000, // USD per hour\n                maintenance_required: true\n            }\n        };\n        \n        this.init();\n    }\n    \n    // üöÄ Initialize Anomaly Generator\n    init() {\n        console.log('üö® Initializing Smart Factory Anomaly Generator...');\n        \n        // Create control interface\n        this.createControlInterface();\n        \n        // Set up real-time monitoring\n        this.setupMonitoring();\n        \n        console.log('‚úÖ Anomaly Generator ready for testing');\n    }\n    \n    // üéÆ Create Control Interface\n    createControlInterface() {\n        const controlPanel = document.createElement('div');\n        controlPanel.id = 'anomaly-generator-panel';\n        controlPanel.innerHTML = this.createControlPanelHTML();\n        \n        // Position as floating panel\n        controlPanel.style.cssText = `\n            position: fixed;\n            top: 20px;\n            left: 20px;\n            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);\n            color: white;\n            padding: 20px;\n            border-radius: 15px;\n            box-shadow: 0 10px 25px rgba(231,76,60,0.3);\n            backdrop-filter: blur(10px);\n            z-index: 2000;\n            min-width: 350px;\n            max-height: 80vh;\n            overflow-y: auto;\n            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n        `;\n        \n        document.body.appendChild(controlPanel);\n        \n        // Add event listeners\n        this.setupControlEvents();\n    }\n    \n    // üé® Create Control Panel HTML\n    createControlPanelHTML() {\n        return `\n            <div style=\"display: flex; align-items: center; margin-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.3); padding-bottom: 10px;\">\n                <h2 style=\"margin: 0; font-size: 16px; font-weight: bold;\">üö® Anomaly Generator</h2>\n                <button id=\"anomaly-minimize\" style=\"\n                    background: none; border: none; color: white; font-size: 18px;\n                    margin-left: auto; cursor: pointer; padding: 5px;\n                \">‚àí</button>\n            </div>\n            \n            <div id=\"anomaly-content\">\n                <div style=\"margin: 10px 0;\">\n                    <label style=\"display: block; font-size: 12px; margin-bottom: 5px;\">üéØ Select Anomaly Type:</label>\n                    <select id=\"anomaly-type-select\" style=\"\n                        width: 100%; padding: 8px; border: none; border-radius: 5px;\n                        background: rgba(255,255,255,0.9); color: #333;\n                    \">\n                        <option value=\"\">-- Choose Anomaly --</option>\n                        ${Object.entries(this.anomalyTypes).map(([key, anomaly]) => \n                            `<option value=\"${key}\">${anomaly.name} (${anomaly.severity.toUpperCase()})</option>`\n                        ).join('')}\n                    </select>\n                </div>\n                \n                <div id=\"anomaly-details\" style=\"margin: 10px 0; display: none;\">\n                    <div id=\"anomaly-description\" style=\"font-size: 11px; opacity: 0.9; margin: 5px 0;\"></div>\n                    <div id=\"anomaly-impact\" style=\"font-size: 10px; opacity: 0.8; margin: 5px 0;\"></div>\n                </div>\n                \n                <div style=\"margin: 15px 0;\">\n                    <label style=\"display: block; font-size: 12px; margin-bottom: 5px;\">üè≠ Target Machine:</label>\n                    <select id=\"target-machine-select\" style=\"\n                        width: 100%; padding: 8px; border: none; border-radius: 5px;\n                        background: rgba(255,255,255,0.9); color: #333;\n                    \">\n                        <option value=\"M001\">M001 - CNC Mill</option>\n                        <option value=\"M002\">M002 - Industrial Robot</option>\n                        <option value=\"M003\">M003 - Assembly Station</option>\n                        <option value=\"M004\">M004 - Quality Scanner</option>\n                        <option value=\"M005\">M005 - Packaging Unit</option>\n                        <option value=\"ALL\">ALL MACHINES</option>\n                    </select>\n                </div>\n                \n                <div style=\"margin: 15px 0;\">\n                    <label style=\"display: block; font-size: 12px; margin-bottom: 5px;\">‚è±Ô∏è Duration (minutes):</label>\n                    <input type=\"number\" id=\"anomaly-duration\" min=\"1\" max=\"480\" value=\"30\" style=\"\n                        width: 100%; padding: 8px; border: none; border-radius: 5px;\n                        background: rgba(255,255,255,0.9); color: #333;\n                    \">\n                </div>\n                \n                <div style=\"margin: 15px 0; display: flex; gap: 10px;\">\n                    <button id=\"inject-anomaly-btn\" style=\"\n                        flex: 1; background: #f39c12; color: white; border: none;\n                        padding: 12px; border-radius: 8px; cursor: pointer;\n                        font-weight: bold; transition: all 0.3s ease;\n                    \">üöÄ Inject Anomaly</button>\n                    \n                    <button id=\"stop-anomalies-btn\" style=\"\n                        flex: 1; background: #27ae60; color: white; border: none;\n                        padding: 12px; border-radius: 8px; cursor: pointer;\n                        font-weight: bold; transition: all 0.3s ease;\n                    \">üõë Stop All</button>\n                </div>\n                \n                <div style=\"margin: 15px 0; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 8px;\">\n                    <h4 style=\"margin: 0 0 10px 0; font-size: 12px;\">üìä Active Anomalies:</h4>\n                    <div id=\"active-anomalies-list\" style=\"font-size: 11px; min-height: 20px;\">\n                        <span style=\"opacity: 0.7;\">No active anomalies</span>\n                    </div>\n                </div>\n                \n                <div style=\"margin: 15px 0; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 8px;\">\n                    <h4 style=\"margin: 0 0 10px 0; font-size: 12px;\">üéØ Impact Tracking:</h4>\n                    <div id=\"impact-tracking\" style=\"font-size: 11px;\">\n                        <div>üí∞ Cost Impact: $<span id=\"total-cost-impact\">0</span>/hr</div>\n                        <div>üè• Health Score: <span id=\"avg-health-impact\">100</span>%</div>\n                        <div>‚ö° System Efficiency: <span id=\"system-efficiency\">100</span>%</div>\n                        <div>üö® Active Alerts: <span id=\"active-alerts-count\">0</span></div>\n                    </div>\n                </div>\n                \n                <div style=\"margin: 15px 0;\">\n                    <h4 style=\"margin: 0 0 10px 0; font-size: 12px;\">üé¨ Quick Test Scenarios:</h4>\n                    <div style=\"display: flex; flex-wrap: wrap; gap: 8px;\">\n                        <button class=\"scenario-btn\" data-scenario=\"demo\" style=\"\n                            background: #3498db; color: white; border: none;\n                            padding: 8px 12px; border-radius: 5px; cursor: pointer;\n                            font-size: 10px; flex: 1;\n                        \">üé≠ Demo Mode</button>\n                        \n                        <button class=\"scenario-btn\" data-scenario=\"stress\" style=\"\n                            background: #e67e22; color: white; border: none;\n                            padding: 8px 12px; border-radius: 5px; cursor: pointer;\n                            font-size: 10px; flex: 1;\n                        \">‚ö° Stress Test</button>\n                        \n                        <button class=\"scenario-btn\" data-scenario=\"cascade\" style=\"\n                            background: #8e44ad; color: white; border: none;\n                            padding: 8px 12px; border-radius: 5px; cursor: pointer;\n                            font-size: 10px; flex: 1;\n                        \">üåä Cascade Failure</button>\n                    </div>\n                </div>\n            </div>\n        `;\n    }\n    \n    // ‚öôÔ∏è Setup Control Events\n    setupControlEvents() {\n        // Anomaly type selection\n        document.getElementById('anomaly-type-select').addEventListener('change', (e) => {\n            this.showAnomalyDetails(e.target.value);\n        });\n        \n        // Inject anomaly button\n        document.getElementById('inject-anomaly-btn').addEventListener('click', () => {\n            this.injectAnomaly();\n        });\n        \n        // Stop all anomalies button\n        document.getElementById('stop-anomalies-btn').addEventListener('click', () => {\n            this.stopAllAnomalies();\n        });\n        \n        // Minimize button\n        document.getElementById('anomaly-minimize').addEventListener('click', () => {\n            this.toggleMinimize();\n        });\n        \n        // Quick scenario buttons\n        document.querySelectorAll('.scenario-btn').forEach(btn => {\n            btn.addEventListener('click', (e) => {\n                this.runQuickScenario(e.target.dataset.scenario);\n            });\n        });\n    }\n    \n    // üìã Show Anomaly Details\n    showAnomalyDetails(anomalyType) {\n        const detailsDiv = document.getElementById('anomaly-details');\n        const descriptionDiv = document.getElementById('anomaly-description');\n        const impactDiv = document.getElementById('anomaly-impact');\n        \n        if (!anomalyType) {\n            detailsDiv.style.display = 'none';\n            return;\n        }\n        \n        const anomaly = this.anomalyTypes[anomalyType];\n        \n        descriptionDiv.textContent = `üìñ ${anomaly.description}`;\n        impactDiv.innerHTML = `\n            üí∞ Cost: $${anomaly.cost_impact.toLocaleString()}/hr | \n            ‚è±Ô∏è Duration: ${anomaly.duration.min}-${anomaly.duration.max}min | \n            üîß Maintenance: ${anomaly.maintenance_required ? 'Required' : 'Not Required'}\n        `;\n        \n        detailsDiv.style.display = 'block';\n    }\n    \n    // üöÄ Inject Anomaly\n    async injectAnomaly() {\n        const anomalyType = document.getElementById('anomaly-type-select').value;\n        const targetMachine = document.getElementById('target-machine-select').value;\n        const duration = parseInt(document.getElementById('anomaly-duration').value);\n        \n        if (!anomalyType) {\n            alert('Please select an anomaly type');\n            return;\n        }\n        \n        console.log(`üö® Injecting ${anomalyType} anomaly into ${targetMachine} for ${duration} minutes...`);\n        \n        const anomalyId = this.generateAnomalyId();\n        const anomalyConfig = {\n            id: anomalyId,\n            type: anomalyType,\n            target: targetMachine,\n            duration: duration,\n            startTime: new Date(),\n            config: this.anomalyTypes[anomalyType]\n        };\n        \n        // Start the anomaly cascade\n        await this.executeAnomalyCascade(anomalyConfig);\n        \n        // Track active anomaly\n        this.activeAnomalies.set(anomalyId, anomalyConfig);\n        \n        // Update UI\n        this.updateActiveAnomaliesList();\n        \n        // Schedule auto-stop\n        setTimeout(() => {\n            this.stopAnomaly(anomalyId);\n        }, duration * 60000); // Convert minutes to milliseconds\n    }\n    \n    // üåä Execute Anomaly Cascade (End-to-End Impact)\n    async executeAnomalyCascade(anomalyConfig) {\n        console.log(`üåä Starting anomaly cascade for ${anomalyConfig.id}...`);\n        \n        try {\n            // Phase 1: Factory/IoT Sensors (Immediate)\n            await this.impactFactorySensors(anomalyConfig);\n            \n            // Phase 2: Azure Digital Twins (1-2 seconds delay)\n            setTimeout(() => {\n                this.impactDigitalTwins(anomalyConfig);\n            }, 1000);\n            \n            // Phase 3: ML Models & Health Modeling (3-5 seconds delay)\n            setTimeout(() => {\n                this.impactMLModels(anomalyConfig);\n                this.impactHealthModeling(anomalyConfig);\n            }, 3000);\n            \n            // Phase 4: Dashboard & UI Updates (5-8 seconds delay)\n            setTimeout(() => {\n                this.impactDashboard(anomalyConfig);\n                this.impact3DVisualization(anomalyConfig);\n            }, 5000);\n            \n            // Phase 5: Notifications & Alerts (8-10 seconds delay)\n            setTimeout(() => {\n                this.triggerNotifications(anomalyConfig);\n            }, 8000);\n            \n            console.log(`‚úÖ Anomaly cascade initiated successfully for ${anomalyConfig.id}`);\n            \n        } catch (error) {\n            console.error(`‚ùå Anomaly cascade failed for ${anomalyConfig.id}:`, error);\n        }\n    }\n    \n    // üè≠ Impact Factory Sensors\n    async impactFactorySensors(anomalyConfig) {\n        console.log(`üè≠ [Phase 1] Impacting factory sensors for ${anomalyConfig.target}...`);\n        \n        const symptoms = anomalyConfig.config.symptoms;\n        const sensorData = {\n            machine_id: anomalyConfig.target,\n            anomaly_type: anomalyConfig.type,\n            symptoms: symptoms,\n            timestamp: new Date().toISOString(),\n            severity: anomalyConfig.config.severity\n        };\n        \n        // Simulate IoT sensor data changes\n        if (window.factoryData && window.factoryData.machines) {\n            const machines = anomalyConfig.target === 'ALL' ? \n                Object.keys(window.factoryData.machines) : [anomalyConfig.target];\n                \n            machines.forEach(machineId => {\n                this.updateMachineMetrics(machineId, symptoms);\n            });\n        }\n        \n        // Track impact start\n        this.impactTracker.set(anomalyConfig.id, {\n            phase: 1,\n            description: 'Factory sensors impacted',\n            timestamp: new Date()\n        });\n    }\n    \n    // üîó Impact Digital Twins\n    async impactDigitalTwins(anomalyConfig) {\n        console.log(`üîó [Phase 2] Updating Azure Digital Twins for ${anomalyConfig.target}...`);\n        \n        // Update digital twin properties\n        const dtUpdate = {\n            machine_id: anomalyConfig.target,\n            anomaly_detected: true,\n            anomaly_type: anomalyConfig.type,\n            health_score: this.calculateNewHealthScore(anomalyConfig),\n            status: anomalyConfig.config.severity === 'critical' ? 'maintenance' : 'warning',\n            last_anomaly: new Date().toISOString()\n        };\n        \n        // Simulate Azure Digital Twins update\n        if (window.digitalTwinData) {\n            const machines = anomalyConfig.target === 'ALL' ? \n                window.digitalTwinData.machines.keys() : [anomalyConfig.target];\n                \n            for (const machineId of machines) {\n                if (window.digitalTwinData.machines.has(machineId)) {\n                    const currentData = window.digitalTwinData.machines.get(machineId);\n                    window.digitalTwinData.machines.set(machineId, {\n                        ...currentData,\n                        ...dtUpdate,\n                        machine_id: machineId\n                    });\n                }\n            }\n        }\n        \n        // Update impact tracking\n        this.impactTracker.set(anomalyConfig.id, {\n            phase: 2,\n            description: 'Digital twins updated',\n            timestamp: new Date()\n        });\n    }\n    \n    // ü§ñ Impact ML Models\n    async impactMLModels(anomalyConfig) {\n        console.log(`ü§ñ [Phase 3] ML models detecting anomaly for ${anomalyConfig.target}...`);\n        \n        // Simulate ML model anomaly detection\n        const mlPrediction = {\n            anomaly_detected: true,\n            confidence: 0.85 + Math.random() * 0.14, // 85-99% confidence\n            anomaly_type: anomalyConfig.type,\n            predicted_failure_time: new Date(Date.now() + (Math.random() * 4 + 1) * 3600000), // 1-5 hours\n            recommendation: this.generateMLRecommendation(anomalyConfig),\n            cost_impact: anomalyConfig.config.cost_impact\n        };\n        \n        // Update ML predictions in global state\n        if (window.mlPredictions) {\n            const machines = anomalyConfig.target === 'ALL' ? \n                ['M001', 'M002', 'M003', 'M004', 'M005'] : [anomalyConfig.target];\n                \n            machines.forEach(machineId => {\n                window.mlPredictions[machineId] = {\n                    ...window.mlPredictions[machineId],\n                    anomaly: mlPrediction\n                };\n            });\n        }\n        \n        // Update impact tracking\n        this.impactTracker.set(anomalyConfig.id, {\n            phase: 3,\n            description: 'ML models detected anomaly',\n            timestamp: new Date()\n        });\n    }\n    \n    // üè• Impact Health Modeling\n    async impactHealthModeling(anomalyConfig) {\n        console.log(`üè• [Phase 3b] Health modeling analyzing impact for ${anomalyConfig.target}...`);\n        \n        const healthImpact = {\n            overall_health_degradation: this.calculateHealthDegradation(anomalyConfig),\n            affected_components: this.identifyAffectedComponents(anomalyConfig),\n            predicted_cascade_effects: this.predictCascadeEffects(anomalyConfig),\n            recommended_actions: this.generateHealthRecommendations(anomalyConfig)\n        };\n        \n        // Update health modeling data\n        if (window.SmartFactoryHealthModel || window.getHealthStatistics) {\n            // Simulate health score update\n            const machines = anomalyConfig.target === 'ALL' ? \n                ['M001', 'M002', 'M003', 'M004', 'M005'] : [anomalyConfig.target];\n                \n            machines.forEach(machineId => {\n                if (window.SmartFactoryHealthModel && window.SmartFactoryHealthModel.digitalTwins) {\n                    const currentTwin = window.SmartFactoryHealthModel.digitalTwins[machineId];\n                    if (currentTwin) {\n                        currentTwin.health_score *= (1 - healthImpact.overall_health_degradation);\n                        currentTwin.anomaly_active = true;\n                        currentTwin.anomaly_type = anomalyConfig.type;\n                    }\n                }\n            });\n        }\n    }\n    \n    // üìä Impact Dashboard\n    async impactDashboard(anomalyConfig) {\n        console.log(`üìä [Phase 4] Updating dashboard for ${anomalyConfig.target}...`);\n        \n        // Update machine status indicators\n        const machines = anomalyConfig.target === 'ALL' ? \n            ['M001', 'M002', 'M003', 'M004', 'M005'] : [anomalyConfig.target];\n            \n        machines.forEach(machineId => {\n            // Update machine status in UI\n            const machineElement = document.getElementById(`machine-${machineId}`);\n            if (machineElement) {\n                const statusElement = machineElement.querySelector('.machine-status');\n                const indicatorElement = machineElement.querySelector('.status-indicator');\n                \n                if (statusElement) {\n                    statusElement.textContent = `Status: ${anomalyConfig.config.severity} - ${anomalyConfig.type.replace('_', ' ')}`;\n                    statusElement.className = `machine-status status-${anomalyConfig.config.severity}`;\n                }\n                \n                if (indicatorElement) {\n                    indicatorElement.className = `status-indicator status-${anomalyConfig.config.severity}`;\n                }\n            }\n        });\n        \n        // Show dashboard alert\n        this.showDashboardAlert(anomalyConfig);\n        \n        // Update metrics in real-time\n        this.updateDashboardMetrics(anomalyConfig);\n    }\n    \n    // üéÆ Impact 3D Visualization\n    async impact3DVisualization(anomalyConfig) {\n        console.log(`üéÆ [Phase 4b] Updating 3D visualization for ${anomalyConfig.target}...`);\n        \n        if (window.factory3D) {\n            const machines = anomalyConfig.target === 'ALL' ? \n                Object.keys(window.factory3D.machines || {}) : [anomalyConfig.target];\n                \n            machines.forEach(machineId => {\n                // Update 3D machine material\n                if (window.advanced3DMaterials) {\n                    const newHealthScore = this.calculateNewHealthScore(anomalyConfig) / 100;\n                    const temperature = 20 + (anomalyConfig.config.symptoms.temperature?.increase || 0);\n                    \n                    window.advanced3DMaterials.updateMachineStatus(\n                        machineId, \n                        anomalyConfig.config.severity,\n                        newHealthScore,\n                        temperature\n                    );\n                }\n                \n                // Trigger alert particles\n                if (window.particleSystem) {\n                    const machine = window.factory3D.machines[machineId];\n                    if (machine && machine.mesh) {\n                        window.particleSystem.triggerAlert(\n                            machine.mesh.position,\n                            anomalyConfig.config.severity\n                        );\n                    }\n                }\n                \n                // Update machine color and effects in 3D scene\n                if (window.factory3D.updateDigitalTwinData) {\n                    window.factory3D.updateDigitalTwinData(machineId, {\n                        status: anomalyConfig.config.severity,\n                        health_score: this.calculateNewHealthScore(anomalyConfig),\n                        anomaly_type: anomalyConfig.type,\n                        symptoms: anomalyConfig.config.symptoms\n                    });\n                }\n            });\n        }\n    }\n    \n    // üì¢ Trigger Notifications\n    async triggerNotifications(anomalyConfig) {\n        console.log(`üì¢ [Phase 5] Triggering notifications for ${anomalyConfig.target}...`);\n        \n        // Browser notification\n        if ('Notification' in window && Notification.permission === 'granted') {\n            new Notification(`üö® Factory Alert: ${anomalyConfig.config.name}`, {\n                body: `${anomalyConfig.config.description} detected on ${anomalyConfig.target}`,\n                icon: 'data:image/svg+xml,%3Csvg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 100 100\"%3E%3Ctext y=\".9em\" font-size=\"90\"%3Eüö®%3C/text%3E%3C/svg%3E',\n                tag: anomalyConfig.id\n            });\n        }\n        \n        // Show maintenance alerts\n        this.updateMaintenancePanel(anomalyConfig);\n        \n        // Update alerts in all panels\n        this.updateAllAlertPanels(anomalyConfig);\n        \n        // Final impact tracking update\n        this.impactTracker.set(anomalyConfig.id, {\n            phase: 5,\n            description: 'All systems notified',\n            timestamp: new Date(),\n            complete: true\n        });\n    }\n    \n    // üé≠ Quick Test Scenarios\n    runQuickScenario(scenario) {\n        console.log(`üé≠ Running quick scenario: ${scenario}`);\n        \n        switch (scenario) {\n            case 'demo':\n                this.runDemoScenario();\n                break;\n            case 'stress':\n                this.runStressTest();\n                break;\n            case 'cascade':\n                this.runCascadeFailure();\n                break;\n        }\n    }\n    \n    runDemoScenario() {\n        console.log('üé≠ Starting demo scenario...');\n        \n        // Sequential demo anomalies\n        setTimeout(() => this.injectSpecificAnomaly('thermal_overload', 'M001', 5), 1000);\n        setTimeout(() => this.injectSpecificAnomaly('quality_degradation', 'M003', 10), 15000);\n        setTimeout(() => this.injectSpecificAnomaly('network_disruption', 'ALL', 3), 30000);\n    }\n    \n    runStressTest() {\n        console.log('‚ö° Starting stress test...');\n        \n        // Multiple simultaneous anomalies\n        this.injectSpecificAnomaly('mechanical_failure', 'M001', 15);\n        this.injectSpecificAnomaly('thermal_overload', 'M002', 10);\n        this.injectSpecificAnomaly('quality_degradation', 'M003', 20);\n        this.injectSpecificAnomaly('power_anomaly', 'ALL', 5);\n    }\n    \n    runCascadeFailure() {\n        console.log('üåä Starting cascade failure...');\n        \n        // Cascading failures with delays\n        setTimeout(() => this.injectSpecificAnomaly('power_anomaly', 'ALL', 2), 1000);\n        setTimeout(() => this.injectSpecificAnomaly('network_disruption', 'ALL', 5), 5000);\n        setTimeout(() => this.injectSpecificAnomaly('cybersecurity_incident', 'ALL', 1), 10000);\n        setTimeout(() => this.injectSpecificAnomaly('supply_chain_disruption', 'ALL', 30), 15000);\n    }\n    \n    // Helper Methods\n    injectSpecificAnomaly(type, target, duration) {\n        const anomalyId = this.generateAnomalyId();\n        const anomalyConfig = {\n            id: anomalyId,\n            type: type,\n            target: target,\n            duration: duration,\n            startTime: new Date(),\n            config: this.anomalyTypes[type]\n        };\n        \n        this.executeAnomalyCascade(anomalyConfig);\n        this.activeAnomalies.set(anomalyId, anomalyConfig);\n        this.updateActiveAnomaliesList();\n        \n        setTimeout(() => {\n            this.stopAnomaly(anomalyId);\n        }, duration * 60000);\n    }\n    \n    generateAnomalyId() {\n        return `ANOM_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`;\n    }\n    \n    calculateNewHealthScore(anomalyConfig) {\n        const baseScore = 95;\n        const degradation = anomalyConfig.config.symptoms.health_score?.decrease || 30;\n        return Math.max(10, baseScore - degradation);\n    }\n    \n    // üõë Stop Anomaly\n    stopAnomaly(anomalyId) {\n        if (this.activeAnomalies.has(anomalyId)) {\n            const anomaly = this.activeAnomalies.get(anomalyId);\n            console.log(`üõë Stopping anomaly ${anomalyId} (${anomaly.type})...`);\n            \n            // Restore normal state\n            this.restoreNormalState(anomaly);\n            \n            // Remove from active list\n            this.activeAnomalies.delete(anomalyId);\n            this.impactTracker.delete(anomalyId);\n            \n            // Update UI\n            this.updateActiveAnomaliesList();\n            \n            console.log(`‚úÖ Anomaly ${anomalyId} stopped and systems restored`);\n        }\n    }\n    \n    stopAllAnomalies() {\n        console.log('üõë Stopping all active anomalies...');\n        \n        const anomalyIds = Array.from(this.activeAnomalies.keys());\n        anomalyIds.forEach(id => this.stopAnomaly(id));\n        \n        console.log('‚úÖ All anomalies stopped');\n    }\n    \n    // üîÑ Restore Normal State\n    restoreNormalState(anomaly) {\n        const machines = anomaly.target === 'ALL' ? \n            ['M001', 'M002', 'M003', 'M004', 'M005'] : [anomaly.target];\n            \n        machines.forEach(machineId => {\n            // Restore dashboard status\n            const machineElement = document.getElementById(`machine-${machineId}`);\n            if (machineElement) {\n                const statusElement = machineElement.querySelector('.machine-status');\n                const indicatorElement = machineElement.querySelector('.status-indicator');\n                \n                if (statusElement) {\n                    statusElement.textContent = 'Status: running';\n                    statusElement.className = 'machine-status status-running';\n                }\n                \n                if (indicatorElement) {\n                    indicatorElement.className = 'status-indicator status-running';\n                }\n            }\n            \n            // Restore 3D visualization\n            if (window.advanced3DMaterials) {\n                window.advanced3DMaterials.updateMachineStatus(machineId, 'running', 0.95, 20);\n            }\n            \n            // Restore health modeling\n            if (window.SmartFactoryHealthModel && window.SmartFactoryHealthModel.digitalTwins) {\n                const twin = window.SmartFactoryHealthModel.digitalTwins[machineId];\n                if (twin) {\n                    twin.health_score = 95;\n                    twin.anomaly_active = false;\n                    twin.anomaly_type = null;\n                }\n            }\n        });\n    }\n    \n    // üìä Update UI Components\n    updateActiveAnomaliesList() {\n        const listElement = document.getElementById('active-anomalies-list');\n        const costElement = document.getElementById('total-cost-impact');\n        const healthElement = document.getElementById('avg-health-impact');\n        const efficiencyElement = document.getElementById('system-efficiency');\n        const alertsElement = document.getElementById('active-alerts-count');\n        \n        if (this.activeAnomalies.size === 0) {\n            listElement.innerHTML = '<span style=\"opacity: 0.7;\">No active anomalies</span>';\n            if (costElement) costElement.textContent = '0';\n            if (healthElement) healthElement.textContent = '100';\n            if (efficiencyElement) efficiencyElement.textContent = '100';\n            if (alertsElement) alertsElement.textContent = '0';\n            return;\n        }\n        \n        let totalCost = 0;\n        let totalHealthImpact = 0;\n        let totalEfficiencyImpact = 0;\n        \n        const activeList = Array.from(this.activeAnomalies.values()).map(anomaly => {\n            totalCost += anomaly.config.cost_impact;\n            totalHealthImpact += anomaly.config.symptoms.health_score?.decrease || 0;\n            totalEfficiencyImpact += anomaly.config.symptoms.efficiency?.decrease || 0;\n            \n            const remainingTime = Math.max(0, \n                anomaly.duration - Math.floor((Date.now() - anomaly.startTime.getTime()) / 60000)\n            );\n            \n            return `\n                <div style=\"margin: 5px 0; padding: 5px; background: rgba(255,255,255,0.1); border-radius: 3px;\">\n                    <strong>${anomaly.config.name}</strong> on ${anomaly.target}<br>\n                    <small>‚è±Ô∏è ${remainingTime}min remaining | üí∞ $${anomaly.config.cost_impact.toLocaleString()}/hr</small>\n                </div>\n            `;\n        }).join('');\n        \n        listElement.innerHTML = activeList;\n        \n        // Update impact metrics\n        if (costElement) costElement.textContent = totalCost.toLocaleString();\n        if (healthElement) healthElement.textContent = Math.max(0, 100 - totalHealthImpact / this.activeAnomalies.size);\n        if (efficiencyElement) efficiencyElement.textContent = Math.max(0, 100 - totalEfficiencyImpact / this.activeAnomalies.size);\n        if (alertsElement) alertsElement.textContent = this.activeAnomalies.size;\n    }\n    \n    // Additional helper methods...\n    updateMachineMetrics(machineId, symptoms) {\n        // Update machine metrics based on symptoms\n        console.log(`üìä Updating metrics for ${machineId}:`, symptoms);\n    }\n    \n    showDashboardAlert(anomalyConfig) {\n        if (window.showAlert) {\n            window.showAlert(`${anomalyConfig.config.name} detected on ${anomalyConfig.target}`);\n        }\n    }\n    \n    updateDashboardMetrics(anomalyConfig) {\n        // Update various dashboard metrics\n        console.log(`üìä Updating dashboard metrics for ${anomalyConfig.type}`);\n    }\n    \n    updateMaintenancePanel(anomalyConfig) {\n        // Add to maintenance alerts if maintenance required\n        if (anomalyConfig.config.maintenance_required) {\n            const alertsContainer = document.getElementById('maintenance-alerts');\n            if (alertsContainer) {\n                const alertDiv = document.createElement('div');\n                alertDiv.className = 'maintenance-alert maintenance-critical';\n                alertDiv.innerHTML = `\n                    <div class=\"maintenance-item\">\n                        <div class=\"maintenance-machine\">${anomalyConfig.target}</div>\n                        <div class=\"maintenance-time\">IMMEDIATE</div>\n                    </div>\n                    <div style=\"font-size: 12px; opacity: 0.9;\">${anomalyConfig.config.description}</div>\n                `;\n                alertsContainer.insertBefore(alertDiv, alertsContainer.firstChild);\n            }\n        }\n    }\n    \n    updateAllAlertPanels(anomalyConfig) {\n        // Update all alert panels across the system\n        console.log(`üö® Updating all alert panels for ${anomalyConfig.type}`);\n    }\n    \n    toggleMinimize() {\n        const content = document.getElementById('anomaly-content');\n        const button = document.getElementById('anomaly-minimize');\n        \n        if (content.style.display === 'none') {\n            content.style.display = 'block';\n            button.textContent = '‚àí';\n        } else {\n            content.style.display = 'none';\n            button.textContent = '+';\n        }\n    }\n    \n    // Helper calculation methods\n    calculateHealthDegradation(anomalyConfig) {\n        return (anomalyConfig.config.symptoms.health_score?.decrease || 30) / 100;\n    }\n    \n    identifyAffectedComponents(anomalyConfig) {\n        return ['infrastructure', 'services', 'operations']; // Simplified\n    }\n    \n    predictCascadeEffects(anomalyConfig) {\n        return [`Secondary failures possible in ${Math.floor(Math.random() * 30 + 10)} minutes`];\n    }\n    \n    generateHealthRecommendations(anomalyConfig) {\n        return [`Immediate inspection of ${anomalyConfig.target}`, 'Monitor thermal conditions', 'Check power supply'];\n    }\n    \n    generateMLRecommendation(anomalyConfig) {\n        const recommendations = {\n            mechanical_failure: 'Schedule immediate bearing replacement',\n            thermal_overload: 'Check cooling system and reduce load',\n            quality_degradation: 'Calibrate quality control sensors',\n            power_anomaly: 'Inspect electrical connections and voltage regulators',\n            network_disruption: 'Check network infrastructure and reset connections',\n            supply_chain_disruption: 'Source alternative materials and adjust quality parameters',\n            cybersecurity_incident: 'Isolate affected systems and run security scan'\n        };\n        \n        return recommendations[anomalyConfig.type] || 'Contact maintenance team for inspection';\n    }\n    \n    setupMonitoring() {\n        // Set up continuous monitoring of system state\n        setInterval(() => {\n            this.updateActiveAnomaliesList();\n        }, 5000); // Update every 5 seconds\n    }\n}\n\n// üöÄ Auto-initialize when loaded\nif (typeof window !== 'undefined') {\n    window.SmartFactoryAnomalyGenerator = SmartFactoryAnomalyGenerator;\n    \n    // Initialize after DOM is ready\n    document.addEventListener('DOMContentLoaded', () => {\n        // Initialize after a delay to ensure other systems are loaded\n        setTimeout(() => {\n            window.anomalyGenerator = new SmartFactoryAnomalyGenerator();\n            console.log('‚úÖ Smart Factory Anomaly Generator ready for testing!');\n        }, 3000);\n    });\n}\n\nexport default SmartFactoryAnomalyGenerator;