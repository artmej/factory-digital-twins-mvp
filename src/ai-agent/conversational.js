// ðŸ’¬ Conversational AI for Smart Factory Agent
// Natural Language Processing and Chat Interface

class ConversationalAI {
    constructor() {\n        this.name = \"FactoryBot Assistant\";\n        this.language = 'auto'; // auto-detect between ES/EN\n        this.context = {\n            factory_data: null,\n            user_preferences: {},\n            conversation_history: [],\n            current_session: new Date()\n        };\n        \n        this.responses = {\n            en: {\n                greeting: [\n                    \"ðŸ‘‹ Hello! I'm FactoryBot, your Smart Factory AI assistant. How can I help you today?\",\n                    \"ðŸ­ Welcome to Smart Factory! I'm here to help you with operations, maintenance, and insights.\",\n                    \"âœ¨ Hi there! Ready to optimize your factory operations? What would you like to know?\"\n                ],\n                status_query: {\n                    machines: \"ðŸ”§ Currently {active} of {total} machines are operational. {maintenance} machines are scheduled for maintenance.\",\n                    production: \"ðŸ“Š Production efficiency is at {efficiency}%, running at {current_rate}% of target capacity.\",\n                    alerts: \"ðŸš¨ There are {count} active alerts requiring attention.\"\n                },\n                maintenance: {\n                    prediction: \"ðŸ”® Machine {machine} needs maintenance in {time} with {confidence}% confidence.\",\n                    schedule: \"ðŸ“… Maintenance scheduled for {date}. Estimated downtime: {duration}.\",\n                    optimization: \"ðŸ’¡ I recommend optimizing maintenance schedules to save {savings}% on costs.\"\n                },\n                help: [\n                    \"I can help you with:\\nðŸ”§ Machine status and maintenance\\nðŸ“Š Production metrics\\nâš¡ Energy optimization\\nðŸ” Anomaly detection\\nðŸ“ˆ Performance insights\",\n                    \"Ask me about:\\nâ€¢ 'What's the factory status?'\\nâ€¢ 'When is the next maintenance?'\\nâ€¢ 'Show me energy consumption'\\nâ€¢ 'Any alerts or anomalies?'\"\n                ],\n                unknown: [\n                    \"ðŸ¤” I'm not sure I understand. Could you rephrase your question?\",\n                    \"â“ I didn't catch that. Try asking about factory status, maintenance, or production.\",\n                    \"ðŸ’­ Could you be more specific? I can help with operations, maintenance, and analytics.\"\n                ]\n            },\n            es: {\n                greeting: [\n                    \"ðŸ‘‹ Â¡Hola! Soy FactoryBot, tu asistente de IA para Smart Factory. Â¿CÃ³mo puedo ayudarte hoy?\",\n                    \"ðŸ­ Â¡Bienvenido a Smart Factory! Estoy aquÃ­ para ayudarte con operaciones, mantenimiento e insights.\",\n                    \"âœ¨ Â¡Hola! Â¿Listo para optimizar las operaciones de tu fÃ¡brica? Â¿QuÃ© te gustarÃ­a saber?\"\n                ],\n                status_query: {\n                    machines: \"ðŸ”§ Actualmente {active} de {total} mÃ¡quinas estÃ¡n operativas. {maintenance} mÃ¡quinas tienen mantenimiento programado.\",\n                    production: \"ðŸ“Š La eficiencia de producciÃ³n estÃ¡ en {efficiency}%, funcionando al {current_rate}% de la capacidad objetivo.\",\n                    alerts: \"ðŸš¨ Hay {count} alertas activas que requieren atenciÃ³n.\"\n                },\n                maintenance: {\n                    prediction: \"ðŸ”® La mÃ¡quina {machine} necesita mantenimiento en {time} con {confidence}% de confianza.\",\n                    schedule: \"ðŸ“… Mantenimiento programado para {date}. Tiempo de inactividad estimado: {duration}.\",\n                    optimization: \"ðŸ’¡ Recomiendo optimizar los horarios de mantenimiento para ahorrar {savings}% en costos.\"\n                },\n                help: [\n                    \"Puedo ayudarte con:\\nðŸ”§ Estado de mÃ¡quinas y mantenimiento\\nðŸ“Š MÃ©tricas de producciÃ³n\\nâš¡ OptimizaciÃ³n energÃ©tica\\nðŸ” DetecciÃ³n de anomalÃ­as\\nðŸ“ˆ Insights de rendimiento\",\n                    \"PregÃºntame sobre:\\nâ€¢ 'Â¿CuÃ¡l es el estado de la fÃ¡brica?'\\nâ€¢ 'Â¿CuÃ¡ndo es el prÃ³ximo mantenimiento?'\\nâ€¢ 'MuÃ©strame el consumo energÃ©tico'\\nâ€¢ 'Â¿Hay alertas o anomalÃ­as?'\"\n                ],\n                unknown: [\n                    \"ðŸ¤” No estoy seguro de entender. Â¿PodrÃ­as reformular tu pregunta?\",\n                    \"â“ No entendÃ­ eso. Intenta preguntar sobre estado de fÃ¡brica, mantenimiento o producciÃ³n.\",\n                    \"ðŸ’­ Â¿PodrÃ­as ser mÃ¡s especÃ­fico? Puedo ayudar con operaciones, mantenimiento y anÃ¡lisis.\"\n                ]\n            }\n        };\n        \n        this.intents = {\n            greeting: {\n                patterns: [\n                    /^(hi|hello|hey|hola|buenos dÃ­as|good morning)/i,\n                    /^(help|ayuda|what can you do|quÃ© puedes hacer)/i\n                ],\n                confidence_threshold: 0.8\n            },\n            factory_status: {\n                patterns: [\n                    /(factory|fÃ¡brica|plant|planta).*(status|estado|condition|condiciÃ³n)/i,\n                    /(how|cÃ³mo).*(factory|fÃ¡brica|production|producciÃ³n|running|funcionando)/i,\n                    /(overview|resumen|summary|estado general)/i\n                ],\n                confidence_threshold: 0.7\n            },\n            maintenance: {\n                patterns: [\n                    /(maintenance|mantenimiento).*(when|cuÃ¡ndo|next|prÃ³ximo|due|vence)/i,\n                    /(machine|mÃ¡quina).*(repair|reparar|fix|arreglar|service|servicio)/i,\n                    /(predict|predecir|forecast|pronÃ³stico).*(maintenance|mantenimiento)/i\n                ],\n                confidence_threshold: 0.75\n            },\n            energy: {\n                patterns: [\n                    /(energy|energÃ­a|power|potencia).*(consumption|consumo|usage|uso)/i,\n                    /(optimize|optimizar|save|ahorrar).*(energy|energÃ­a)/i,\n                    /(efficiency|eficiencia).*(energy|energÃ©tica)/i\n                ],\n                confidence_threshold: 0.7\n            },\n            alerts: {\n                patterns: [\n                    /(alert|alerta|warning|advertencia|alarm|alarma)/i,\n                    /(problem|problema|issue|problema|error)/i,\n                    /(anomaly|anomalÃ­a|unusual|inusual)/i\n                ],\n                confidence_threshold: 0.8\n            },\n            production: {\n                patterns: [\n                    /(production|producciÃ³n).*(rate|tasa|speed|velocidad|output|salida)/i,\n                    /(efficiency|eficiencia).*(production|producciÃ³n)/i,\n                    /(quality|calidad).*(metrics|mÃ©tricas|score|puntuaciÃ³n)/i\n                ],\n                confidence_threshold: 0.7\n            }\n        };\n    }\n    \n    // ðŸš€ Initialize conversational AI\n    async initialize() {\n        console.log('ðŸ’¬ Initializing Conversational AI...');\n        \n        // Set up language detection\n        this.setupLanguageDetection();\n        \n        // Load conversation history if available\n        this.loadConversationHistory();\n        \n        console.log('âœ… Conversational AI initialized');\n    }\n    \n    // ðŸŒ Setup language detection\n    setupLanguageDetection() {\n        this.detectLanguage = (text) => {\n            const spanishWords = ['quÃ©', 'cÃ³mo', 'cuÃ¡ndo', 'dÃ³nde', 'por quÃ©', 'mÃ¡quina', 'producciÃ³n', 'mantenimiento', 'energÃ­a'];\n            const englishWords = ['what', 'how', 'when', 'where', 'why', 'machine', 'production', 'maintenance', 'energy'];\n            \n            const spanishCount = spanishWords.filter(word => text.toLowerCase().includes(word)).length;\n            const englishCount = englishWords.filter(word => text.toLowerCase().includes(word)).length;\n            \n            if (spanishCount > englishCount) {\n                return 'es';\n            } else if (englishCount > spanishCount) {\n                return 'en';\n            } else {\n                return this.language === 'auto' ? 'en' : this.language;\n            }\n        };\n    }\n    \n    // ðŸ’¬ Process incoming message\n    async processMessage(message, context = {}) {\n        try {\n            console.log(`ðŸ’­ Processing message: \"${message}\"`);\n            \n            // Update context\n            this.context.factory_data = context.factoryData;\n            \n            // Detect language\n            const detectedLang = this.detectLanguage(message);\n            \n            // Analyze intent\n            const intent = this.analyzeIntent(message);\n            \n            // Generate response\n            const response = await this.generateResponse(intent, message, detectedLang, context);\n            \n            // Log conversation\n            this.logConversation(message, response, intent);\n            \n            return {\n                success: true,\n                message: response.text,\n                intent: intent.name,\n                confidence: intent.confidence,\n                language: detectedLang,\n                timestamp: new Date(),\n                actions: response.actions || []\n            };\n            \n        } catch (error) {\n            console.error('ðŸ’¥ Message processing error:', error);\n            return {\n                success: false,\n                message: this.getErrorResponse(this.detectLanguage(message)),\n                error: error.message\n            };\n        }\n    }\n    \n    // ðŸŽ¯ Analyze user intent\n    analyzeIntent(message) {\n        let bestMatch = {\n            name: 'unknown',\n            confidence: 0\n        };\n        \n        for (const [intentName, intentData] of Object.entries(this.intents)) {\n            for (const pattern of intentData.patterns) {\n                if (pattern.test(message)) {\n                    const confidence = this.calculateConfidence(message, pattern);\n                    \n                    if (confidence > bestMatch.confidence && confidence >= intentData.confidence_threshold) {\n                        bestMatch = {\n                            name: intentName,\n                            confidence: confidence\n                        };\n                    }\n                }\n            }\n        }\n        \n        return bestMatch;\n    }\n    \n    // ðŸ“Š Calculate pattern matching confidence\n    calculateConfidence(message, pattern) {\n        const match = message.match(pattern);\n        if (!match) return 0;\n        \n        const matchLength = match[0].length;\n        const messageLength = message.length;\n        \n        return Math.min(0.95, (matchLength / messageLength) * 1.2);\n    }\n    \n    // ðŸ’¡ Generate response based on intent\n    async generateResponse(intent, message, language, context) {\n        const responses = this.responses[language] || this.responses.en;\n        \n        switch (intent.name) {\n            case 'greeting':\n                return {\n                    text: this.randomChoice(responses.greeting),\n                    actions: ['show_help_options']\n                };\n                \n            case 'factory_status':\n                return await this.generateFactoryStatusResponse(responses, context);\n                \n            case 'maintenance':\n                return await this.generateMaintenanceResponse(responses, context);\n                \n            case 'energy':\n                return await this.generateEnergyResponse(responses, context);\n                \n            case 'alerts':\n                return await this.generateAlertsResponse(responses, context);\n                \n            case 'production':\n                return await this.generateProductionResponse(responses, context);\n                \n            default:\n                return {\n                    text: this.randomChoice(responses.unknown),\n                    actions: ['show_help_options']\n                };\n        }\n    }\n    \n    // ðŸ­ Generate factory status response\n    async generateFactoryStatusResponse(responses, context) {\n        if (!context.factoryData) {\n            return { text: \"ðŸ“Š Factory data is currently unavailable. Please try again later.\" };\n        }\n        \n        const data = context.factoryData;\n        const statusText = responses.status_query.machines\n            .replace('{active}', data.machines.active)\n            .replace('{total}', data.machines.total)\n            .replace('{maintenance}', data.machines.maintenance);\n            \n        const productionText = responses.status_query.production\n            .replace('{efficiency}', data.production.efficiency)\n            .replace('{current_rate}', data.production.current_rate);\n            \n        const alertText = responses.status_query.alerts\n            .replace('{count}', data.alerts.length);\n        \n        return {\n            text: `${statusText}\\n\\n${productionText}\\n\\n${alertText}`,\n            actions: ['show_dashboard', 'show_maintenance_calendar']\n        };\n    }\n    \n    // ðŸ”§ Generate maintenance response\n    async generateMaintenanceResponse(responses, context) {\n        if (!context.factoryData || !context.factoryData.alerts) {\n            return { text: \"ðŸ”§ Maintenance data is currently unavailable.\" };\n        }\n        \n        const maintenanceAlerts = context.factoryData.alerts\n            .filter(alert => alert.type === 'maintenance_due');\n            \n        if (maintenanceAlerts.length === 0) {\n            return {\n                text: \"âœ… All machines are operating normally. No immediate maintenance required.\",\n                actions: ['show_maintenance_calendar']\n            };\n        }\n        \n        const nextMaintenance = maintenanceAlerts[0];\n        const responseText = responses.maintenance.prediction\n            .replace('{machine}', nextMaintenance.machine)\n            .replace('{time}', nextMaintenance.prediction)\n            .replace('{confidence}', Math.round(nextMaintenance.confidence * 100));\n        \n        return {\n            text: responseText,\n            actions: ['show_maintenance_calendar', 'schedule_maintenance']\n        };\n    }\n    \n    // âš¡ Generate energy response\n    async generateEnergyResponse(responses, context) {\n        if (!context.factoryData || !context.factoryData.energy) {\n            return { text: \"âš¡ Energy data is currently unavailable.\" };\n        }\n        \n        const energy = context.factoryData.energy;\n        const optimizationText = responses.maintenance.optimization\n            .replace('{savings}', energy.optimization);\n        \n        return {\n            text: `âš¡ Current energy consumption: ${energy.consumption} kW\\n\\n${optimizationText}`,\n            actions: ['show_energy_dashboard', 'apply_optimizations']\n        };\n    }\n    \n    // ðŸš¨ Generate alerts response\n    async generateAlertsResponse(responses, context) {\n        if (!context.factoryData || !context.factoryData.alerts) {\n            return { text: \"ðŸš¨ Alert data is currently unavailable.\" };\n        }\n        \n        const alerts = context.factoryData.alerts;\n        \n        if (alerts.length === 0) {\n            return {\n                text: \"âœ… No active alerts. All systems are operating normally.\",\n                actions: ['show_dashboard']\n            };\n        }\n        \n        const alertsList = alerts.map(alert => \n            `ðŸš¨ ${alert.type}: ${alert.machine || alert.area} (${alert.priority} priority)`\n        ).join('\\n');\n        \n        return {\n            text: `Active alerts:\\n\\n${alertsList}`,\n            actions: ['show_alerts_dashboard', 'acknowledge_alerts']\n        };\n    }\n    \n    // ðŸ“Š Generate production response\n    async generateProductionResponse(responses, context) {\n        if (!context.factoryData || !context.factoryData.production) {\n            return { text: \"ðŸ“Š Production data is currently unavailable.\" };\n        }\n        \n        const prod = context.factoryData.production;\n        const statusText = responses.status_query.production\n            .replace('{efficiency}', prod.efficiency)\n            .replace('{current_rate}', prod.current_rate);\n        \n        return {\n            text: statusText,\n            actions: ['show_production_dashboard', 'show_quality_metrics']\n        };\n    }\n    \n    // ðŸŽ² Random choice from array\n    randomChoice(array) {\n        return array[Math.floor(Math.random() * array.length)];\n    }\n    \n    // ðŸ“ Log conversation\n    logConversation(message, response, intent) {\n        this.context.conversation_history.push({\n            timestamp: new Date(),\n            user_message: message,\n            bot_response: response.text,\n            intent: intent.name,\n            confidence: intent.confidence\n        });\n        \n        // Keep last 50 conversations\n        if (this.context.conversation_history.length > 50) {\n            this.context.conversation_history = this.context.conversation_history.slice(-25);\n        }\n    }\n    \n    // ðŸ“š Load conversation history\n    loadConversationHistory() {\n        // Load from localStorage if available\n        if (typeof localStorage !== 'undefined') {\n            const saved = localStorage.getItem('factorybot_conversations');\n            if (saved) {\n                try {\n                    this.context.conversation_history = JSON.parse(saved);\n                } catch (error) {\n                    console.warn('Failed to load conversation history:', error);\n                }\n            }\n        }\n    }\n    \n    // ðŸ’¾ Save conversation history\n    saveConversationHistory() {\n        if (typeof localStorage !== 'undefined') {\n            try {\n                localStorage.setItem('factorybot_conversations', \n                    JSON.stringify(this.context.conversation_history));\n            } catch (error) {\n                console.warn('Failed to save conversation history:', error);\n            }\n        }\n    }\n    \n    // âŒ Get error response\n    getErrorResponse(language) {\n        const responses = this.responses[language] || this.responses.en;\n        return this.randomChoice(responses.unknown);\n    }\n    \n    // ðŸ“Š Get conversation statistics\n    getStatistics() {\n        const history = this.context.conversation_history;\n        const intents = {};\n        \n        history.forEach(conv => {\n            intents[conv.intent] = (intents[conv.intent] || 0) + 1;\n        });\n        \n        return {\n            total_conversations: history.length,\n            session_start: this.context.current_session,\n            intent_distribution: intents,\n            average_confidence: history.reduce((sum, conv) => sum + conv.confidence, 0) / history.length || 0\n        };\n    }\n}\n\nexport default ConversationalAI;