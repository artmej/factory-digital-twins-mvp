<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü§ñ Smart Factory Copilot - AI Agent Dashboard</title>
    <script src="https://alcdn.msauth.net/browser/2.30.0/js/msal-browser.min.js">
const AZURE_ML_CONFIG = {
    endpoint: 'https://smartfactory-ml-api.azurewebsites.net',
    useRealModels: true,
    fallbackEnabled: true,
    retryAttempts: 3
};
// Enhanced error handling for Azure endpoints
function handleAzureAPIError(error, fallback = null) {
    console.warn('Azure API Error:', error);
    if (fallback && typeof fallback === 'function') {
        return fallback();
    }
    return {
        error: true,
        message: 'Azure API temporarily unavailable',
        timestamp: new Date().toISOString(),
        source: 'fallback'
    };
}

// Enhanced fetch with retry logic
async function fetchWithRetry(url, options = {}, retries = 3) {
    for (let i = 0; i < retries; i++) {
        try {
            const response = await fetch(url, {
                ...options,
                timeout: 10000
            });
            
            if (response.ok) {
                return await response.json();
            } else {
                throw new Error(HTTP : );
            }
        } catch (error) {
            console.warn(Attempt  failed:, error.message);
            if (i === retries - 1) throw error;
            await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1))); // Progressive delay
        }
    }
}

// Enhanced error handling for Azure endpoints
function handleAzureAPIError(error, fallback = null) {
    console.warn('Azure API Error:', error);
    if (fallback && typeof fallback === 'function') {
        return fallback();
    }
    return {
        error: true,
        message: 'Azure API temporarily unavailable',
        timestamp: new Date().toISOString(),
        source: 'fallback'
    };
}

// Enhanced fetch with retry logic
async function fetchWithRetry(url, options = {}, retries = 3) {
    for (let i = 0; i < retries; i++) {
        try {
            const response = await fetch(url, {
                ...options,
                timeout: 10000
            });
            
            if (response.ok) {
                return await response.json();
            } else {
                throw new Error(HTTP : );
            }
        } catch (error) {
            console.warn(Attempt  failed:, error.message);
            if (i === retries - 1) throw error;
            await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1))); // Progressive delay
        }
    }
}
</script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f0f0f 0%, #1a1a2e 50%, #16213e 100%);
            color: white;
            overflow-x: hidden;
            min-height: 100vh;
        }
        
        .copilot-container {
            display: grid;
            grid-template-columns: 320px 1fr 380px;
            grid-template-rows: 80px 1fr;
            grid-template-areas:
                "header header header"
                "sidebar main assistant";
            height: 100vh;
            gap: 20px;
            padding: 20px;
        }
        
        /* Header */
        .copilot-header {
            grid-area: header;
            background: linear-gradient(135deg, rgba(0,0,0,0.95), rgba(47,79,79,0.8));
            border: 2px solid #00e676;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 30px;
            backdrop-filter: blur(20px);
            box-shadow: 0 8px 32px rgba(0, 230, 118, 0.3);
        }
        
        .copilot-title {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .copilot-title h1 {
            font-size: 28px;
            background: linear-gradient(45deg, #00e676, #00d4aa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: bold;
        }
        
        .ai-status {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(0, 230, 118, 0.1);
            border: 1px solid #00e676;
            border-radius: 20px;
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            background: #00e676;
            border-radius: 50%;
            animation: aiPulse 2s infinite;
        }
        
        @keyframes aiPulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.2); }
        }
        
        /* Left Sidebar - Factory Overview */
        .factory-sidebar {
            grid-area: sidebar;
            background: linear-gradient(145deg, rgba(0,0,0,0.9), rgba(26,35,126,0.5));
            border: 1px solid rgba(0,230,118,0.3);
            border-radius: 20px;
            padding: 25px;
            overflow-y: auto;
        }
        
        .sidebar-section {
            margin-bottom: 30px;
        }
        
        .section-title {
            font-size: 16px;
            font-weight: bold;
            color: #00e676;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 1px solid rgba(0,230,118,0.3);
            padding-bottom: 8px;
        }
        
        /* Factory Health Panel */
        .health-metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .health-metric {
            background: rgba(0,230,118,0.1);
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid rgba(0,230,118,0.3);
        }
        
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #00e676;
        }
        
        .metric-label {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 5px;
        }
        
        /* AI Insights */
        .ai-insights {
            margin-bottom: 25px;
        }
        
        .insight-card {
            background: rgba(0,100,255,0.1);
            border: 1px solid rgba(0,150,255,0.3);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #0096ff;
        }
        
        .insight-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .insight-title {
            font-weight: bold;
            font-size: 14px;
            color: #0096ff;
        }
        
        .insight-confidence {
            font-size: 11px;
            background: rgba(0,150,255,0.2);
            padding: 2px 8px;
            border-radius: 10px;
            color: #0096ff;
        }
        
        .insight-description {
            font-size: 13px;
            line-height: 1.4;
        }
        
        /* Main Dashboard Area */
        .main-dashboard {
            grid-area: main;
            background: linear-gradient(145deg, rgba(0,0,0,0.8), rgba(26,35,126,0.3));
            border: 1px solid rgba(0,230,118,0.3);
            border-radius: 20px;
            padding: 25px;
            overflow-y: auto;
        }
        
        .dashboard-tabs {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }
        
        .tab-btn {
            padding: 12px 20px;
            background: transparent;
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .tab-btn.active {
            background: linear-gradient(45deg, #00e676, #00d4aa);
            border-color: #00e676;
            color: #000;
            font-weight: bold;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* AI Recommendations */
        .recommendations-grid {
            display: grid;
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .recommendation-card {
            background: linear-gradient(135deg, rgba(255,193,7,0.1), rgba(255,152,0,0.1));
            border: 1px solid rgba(255,193,7,0.4);
            border-radius: 12px;
            padding: 20px;
            border-left: 4px solid #ffc107;
        }
        
        .recommendation-priority {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
            margin-bottom: 10px;
        }
        
        .priority-high {
            background: rgba(244,67,54,0.2);
            color: #f44336;
            border: 1px solid #f44336;
        }
        
        .priority-medium {
            background: rgba(255,152,0,0.2);
            color: #ff9800;
            border: 1px solid #ff9800;
        }
        
        .priority-low {
            background: rgba(76,175,80,0.2);
            color: #4caf50;
            border: 1px solid #4caf50;
        }
        
        .recommendation-title {
            font-weight: bold;
            color: #ffc107;
            margin-bottom: 8px;
        }
        
        .recommendation-description {
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 15px;
        }
        
        /* Real-time Operations */
        .operations-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .operation-panel {
            background: rgba(0,0,0,0.4);
            border: 1px solid rgba(0,230,118,0.2);
            border-radius: 12px;
            padding: 20px;
        }
        
        .panel-title {
            font-weight: bold;
            color: #00e676;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .machine-list {
            display: grid;
            gap: 8px;
        }
        
        .machine-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: rgba(255,255,255,0.05);
            border-radius: 6px;
            border-left: 3px solid;
        }
        
        .machine-status.operational { border-left-color: #4caf50; }
        .machine-status.warning { border-left-color: #ff9800; }
        .machine-status.critical { border-left-color: #f44336; }
        
        .machine-name {
            font-weight: bold;
            font-size: 13px;
        }
        
        .machine-metric {
            font-size: 11px;
            opacity: 0.8;
        }
        
        /* Right Assistant Panel */
        .ai-assistant {
            grid-area: assistant;
            background: linear-gradient(145deg, rgba(0,0,0,0.95), rgba(47,79,79,0.5));
            border: 1px solid rgba(0,230,118,0.5);
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .assistant-header {
            padding: 20px;
            background: rgba(0,230,118,0.1);
            border-bottom: 1px solid rgba(0,230,118,0.3);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .assistant-title {
            font-weight: bold;
            color: #00e676;
        }
        
        .assistant-status {
            flex: 1;
            text-align: right;
            font-size: 12px;
            opacity: 0.8;
        }
        
        /* Chat Interface */
        .chat-interface {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .message {
            padding: 12px 15px;
            border-radius: 12px;
            max-width: 85%;
            word-wrap: break-word;
        }
        
        .message.user {
            background: linear-gradient(45deg, #00e676, #00d4aa);
            color: #000;
            align-self: flex-end;
            margin-left: auto;
        }
        
        .message.agent {
            background: rgba(0,100,255,0.2);
            border: 1px solid rgba(0,100,255,0.3);
            color: white;
            align-self: flex-start;
        }
        
        .message-header {
            font-size: 11px;
            opacity: 0.7;
            margin-bottom: 5px;
        }
        
        .message-content {
            line-height: 1.4;
        }
        
        .chat-input-container {
            padding: 20px;
            border-top: 1px solid rgba(0,230,118,0.3);
            background: rgba(0,0,0,0.3);
        }
        
        .chat-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .chat-input {
            flex: 1;
            padding: 12px 15px;
            background: rgba(0,0,0,0.5);
            border: 1px solid rgba(0,230,118,0.3);
            border-radius: 25px;
            color: white;
            outline: none;
        }
        
        .chat-input:focus {
            border-color: #00e676;
            box-shadow: 0 0 10px rgba(0,230,118,0.3);
        }
        
        .send-btn {
            padding: 12px 20px;
            background: linear-gradient(45deg, #00e676, #00d4aa);
            border: none;
            border-radius: 25px;
            color: #000;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .send-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,230,118,0.4);
        }
        
        /* Quick Actions */
        .quick-actions {
            padding: 15px 20px;
            border-top: 1px solid rgba(0,230,118,0.2);
        }
        
        .quick-actions-title {
            font-size: 12px;
            opacity: 0.7;
            margin-bottom: 10px;
        }
        
        .quick-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .quick-btn {
            padding: 6px 12px;
            background: rgba(0,230,118,0.1);
            border: 1px solid rgba(0,230,118,0.3);
            border-radius: 15px;
            color: #00e676;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .quick-btn:hover {
            background: rgba(0,230,118,0.2);
            transform: translateY(-1px);
        }
        
        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in {
            animation: fadeIn 0.6s ease-out;
        }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.3);
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(0,230,118,0.5);
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(0,230,118,0.8);
        }
    </style>
</head>
<body>
    <div class="copilot-container">
        <!-- Header -->
        <div class="copilot-header">
            <div class="copilot-title">
                <span style="font-size: 32px;">ü§ñ</span>
                <h1>Smart Factory Copilot</h1>
            </div>
            <div class="ai-status">
                <div class="status-indicator">
                    <div class="status-dot"></div>
                    <span>AI Agent Active</span>
                </div>
                <div class="status-indicator">
                    <span>Confidence: <strong id="confidence-level">94%</strong></span>
                </div>
                <div class="status-indicator">
                    <span>Decisions Today: <strong id="decisions-count">47</strong></span>
                </div>
            </div>
        </div>
        
        <!-- Left Sidebar -->
        <div class="factory-sidebar">
            <div class="sidebar-section">
                <div class="section-title">üè≠ Factory Health</div>
                <div class="health-metrics">
                    <div class="health-metric">
                        <div class="metric-value" id="oee-metric">94.2%</div>
                        <div class="metric-label">Overall OEE</div>
                    </div>
                    <div class="health-metric">
                        <div class="metric-value" id="uptime-metric">98.1%</div>
                        <div class="metric-label">Uptime</div>
                    </div>
                    <div class="health-metric">
                        <div class="metric-value" id="quality-metric">99.3%</div>
                        <div class="metric-label">Quality</div>
                    </div>
                    <div class="health-metric">
                        <div class="metric-value" id="efficiency-metric">96.7%</div>
                        <div class="metric-label">Efficiency</div>
                    </div>
                </div>
            </div>
            
            <div class="sidebar-section">
                <div class="section-title">üß† AI Insights</div>
                <div class="ai-insights" id="ai-insights-container">
                    <div class="insight-card fade-in">
                        <div class="insight-header">
                            <div class="insight-title">üîÆ Predictive Alert</div>
                            <div class="insight-confidence">97% confident</div>
                        </div>
                        <div class="insight-description">
                            LINE-2-CNC-02 bearings will need replacement within 48 hours based on vibration patterns.
                        </div>
                    </div>
                    
                    <div class="insight-card fade-in">
                        <div class="insight-header">
                            <div class="insight-title">‚ö° Optimization</div>
                            <div class="insight-confidence">89% confident</div>
                        </div>
                        <div class="insight-description">
                            Reducing LINE-3 speed by 3% will improve quality score by 2.1% with minimal throughput impact.
                        </div>
                    </div>
                    
                    <div class="insight-card fade-in">
                        <div class="insight-header">
                            <div class="insight-title">üí∞ Cost Saving</div>
                            <div class="insight-confidence">92% confident</div>
                        </div>
                        <div class="insight-description">
                            Scheduling maintenance during lunch break could save $3,200 in downtime costs.
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Main Dashboard -->
        <div class="main-dashboard">
            <div class="dashboard-tabs">
                <button class="tab-btn active" onclick="switchTab('recommendations')">üéØ AI Recommendations</button>
                <button class="tab-btn" onclick="switchTab('operations')">‚öôÔ∏è Live Operations</button>
                <button class="tab-btn" onclick="switchTab('analytics')">üìä Analytics</button>
            </div>
            
            <!-- AI Recommendations Tab -->
            <div id="recommendations-tab" class="tab-content active">
                <div class="recommendations-grid">
                    <div class="recommendation-card fade-in">
                        <span class="recommendation-priority priority-high">High Priority</span>
                        <div class="recommendation-title">üö® Immediate Maintenance Required</div>
                        <div class="recommendation-description">
                            LINE-2-CNC-02 temperature has exceeded safe operating limits. Immediate shutdown recommended to prevent equipment damage.
                        </div>
                    </div>
                    
                    <div class="recommendation-card fade-in">
                        <span class="recommendation-priority priority-medium">Medium Priority</span>
                        <div class="recommendation-title">‚ö° Energy Optimization Opportunity</div>
                        <div class="recommendation-description">
                            Adjusting LINE-1 and LINE-3 schedules could reduce energy consumption by 12% during peak hours while maintaining production targets.
                        </div>
                    </div>
                    
                    <div class="recommendation-card fade-in">
                        <span class="recommendation-priority priority-medium">Medium Priority</span>
                        <div class="recommendation-title">üîß Preventive Maintenance Window</div>
                        <div class="recommendation-description">
                            Optimal maintenance window identified for next Tuesday 2-4 PM. Multiple machines can be serviced with minimal production impact.
                        </div>
                    </div>
                    </div>
                    
                    <div class="recommendation-card fade-in">
                        <span class="recommendation-priority priority-low">Low Priority</span>
                        <div class="recommendation-title">üìà Production Improvement</div>
                        <div class="recommendation-description">
                            Fine-tuning robot arm calibration on LINE-1-ROBOT-01 could improve precision by 0.8% and reduce waste material.
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Live Operations Tab -->
            <div id="operations-tab" class="tab-content">
                <div class="operations-grid">
                    <div class="operation-panel">
                        <div class="panel-title">
                            üè≠ Production Line Status
                        </div>
                        <div class="machine-list" id="production-status">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                    
                    <div class="operation-panel">
                        <div class="panel-title">
                            üîß Maintenance Queue
                        </div>
                        <div class="machine-list" id="maintenance-queue">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Analytics Tab -->
            <div id="analytics-tab" class="tab-content">
                <div style="text-align: center; padding: 50px;">
                    <h2 style="color: #00e676; margin-bottom: 20px;">üìä AI Analytics Dashboard</h2>
                    <p>Advanced analytics and predictive models visualization coming soon...</p>
                    <div style="margin-top: 30px;">
                        <button class="action-btn primary" onclick="window.open('../executive-dashboard.html', '_blank')">View Executive Dashboard</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- AI Assistant -->
        <div class="ai-assistant">
            <div class="assistant-header">
                <span style="font-size: 20px;">ü§ñ</span>
                <div class="assistant-title">Factory Copilot</div>
                <div class="assistant-status">Online & Learning</div>
            </div>
            
            <div class="chat-interface">
                <div class="chat-messages" id="chat-messages">
                    <div class="message agent fade-in">
                        <div class="message-header">Factory Copilot ‚Ä¢ Ahora</div>
                        <div class="message-content">
                            üëã ¬°Hola! Soy tu Smart Factory Copilot. Estoy monitoreando todas las operaciones de la f√°brica y listo para ayudarte con insights, recomendaciones y automatizaci√≥n. 
                            
                            Puedes preguntarme cosas como:
                            ‚Ä¢ "¬øEn qu√© l√≠nea tengo el siguiente mantenimiento?"
                            ‚Ä¢ "¬øCu√°ndo es el pr√≥ximo mantenimiento?"
                            ‚Ä¢ "¬øC√≥mo est√° funcionando la L√çNEA 2?"
                            
                            ¬øEn qu√© puedo ayudarte hoy?
                        </div>
                    </div>
                    
                    <div class="message agent fade-in">
                        <div class="message-header">Factory Copilot ‚Ä¢ Hace 2 min</div>
                        <div class="message-content">
                            üö® He detectado una anomal√≠a de temperatura en LINE-2-CNC-02. La m√°quina est√° funcionando 15¬∞C por encima del nivel normal. Recomiendo inspecci√≥n inmediata. ¬øDebo programar mantenimiento de emergencia?
                        </div>
                    </div>
                </div>
                
                <div class="quick-actions">
                    <div class="quick-actions-title">Preguntas R√°pidas:</div>
                    <div class="quick-buttons">
                        <span class="quick-btn" onclick="sendQuickMessage('¬øCu√°l es el estado de producci√≥n?')">Estado Producci√≥n</span>
                        <span class="quick-btn" onclick="sendQuickMessage('¬øCu√°ndo es el pr√≥ximo mantenimiento?')">Pr√≥ximo Mantenimiento</span>
                        <span class="quick-btn" onclick="sendQuickMessage('¬øQu√© l√≠nea necesita mantenimiento urgente?')">Mantenimiento Urgente</span>
                        <span class="quick-btn" onclick="sendQuickMessage('¬øC√≥mo est√° funcionando la L√çNEA 2?')">Estado L√çNEA 2</span>
                        <span class="quick-btn" onclick="sendQuickMessage('Optimizar consumo energ√©tico')">Optimizar Energ√≠a</span>
                        <span class="quick-btn" onclick="sendQuickMessage('¬øC√≥mo est√°n las m√©tricas de calidad?')">M√©tricas Calidad</span>
                        <span class="quick-btn" onclick="sendQuickMessage('Ayuda con diagn√≥sticos')">Ayuda</span>
                    </div>
                </div>
                
                <div class="chat-input-container">
                    <div class="chat-input-group">
                        <input type="text" class="chat-input" id="chat-input" placeholder="Preg√∫ntame sobre la f√°brica... ¬øCu√°ndo es el pr√≥ximo mantenimiento?" onkeypress="handleChatInput(event)">
                        <button class="send-btn" onclick="sendMessage()">Enviar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
const AZURE_ML_CONFIG = {
    endpoint: 'https://smartfactory-ml-api.azurewebsites.net',
    useRealModels: true,
    fallbackEnabled: true,
    retryAttempts: 3
};
        // ü§ñ Smart Factory Copilot - Main Logic with Real API Integration
        let chatHistory = [];
        let agentStatus = {
            confidence: 94,
            decisions: 47,
            insights: 12,
            automated_actions: 23
        };
        
        // API Configuration
        const API_BASE = 'https://smartfactory-ml-api.azurewebsites.net';
        
        // Machine data for operations
        const factoryMachines = [
            { id: 'LINE-1-CNC-01', status: 'operational', metric: '92% efficiency', temp: 68.2 },
            { id: 'LINE-1-ROBOT-01', status: 'operational', metric: '94% efficiency', temp: 59.1 },
            { id: 'LINE-1-CONV-01', status: 'operational', metric: '98% efficiency', temp: 45.7 },
            { id: 'LINE-2-CNC-02', status: 'critical', metric: '85¬∞C temp!', temp: 85.1 },
            { id: 'LINE-2-ROBOT-02', status: 'warning', metric: '78% efficiency', temp: 72.3 },
            { id: 'LINE-2-CONV-02', status: 'operational', metric: '96% efficiency', temp: 48.9 },
            { id: 'LINE-3-CNC-03', status: 'operational', metric: '91% efficiency', temp: 66.8 },
            { id: 'LINE-3-ROBOT-03', status: 'operational', metric: '93% efficiency', temp: 61.4 },
            { id: 'LINE-3-CONV-03', status: 'warning', metric: 'Belt tension low', temp: 52.1 }
        ];
        
        // Initialize dashboard
        async function initializeCopilot() {
            console.log('ü§ñ Initializing Smart Factory Copilot...');
            
            try {
                // Load real data from APIs
                await loadCopilotStatus();
                await loadAIInsights();
                
                updateFactoryMetrics();
                updateOperationsStatus();
                startRealTimeUpdates();
                
                console.log('‚úÖ Copilot initialized with real data from Azure');
            } catch (error) {
                console.error('‚ùå Error initializing Copilot:', error);
                // Fall back to demo data
                updateFactoryMetrics();
                updateOperationsStatus();
                startRealTimeUpdates();
                console.log('‚ö†Ô∏è Running in demo mode');
            }
        }
        
        // Load real Copilot status from API
        async function loadCopilotStatus() {
            try {
                const response = await fetch(`${API_BASE}/status`);
                if (response.ok) {
                    const data = await response.json();
                    
                    agentStatus.confidence = data.confidence;
                    agentStatus.decisions = data.decisions_today;
                    
                    document.getElementById('confidence-level').textContent = Math.round(agentStatus.confidence) + '%';
                    document.getElementById('decisions-count').textContent = agentStatus.decisions;
                    
                    console.log('‚úÖ Loaded real Copilot status');
                } else {
                    throw new Error(`API responded with status: ${response.status}`);
                }
            } catch (error) {
                console.log('‚ö†Ô∏è API unavailable, using simulated data:', error.message);
                // Use realistic simulated data
                agentStatus.confidence = Math.floor(Math.random() * 15) + 85; // 85-99%
                agentStatus.decisions = Math.floor(Math.random() * 50) + 120; // 120-170
                
                document.getElementById('confidence-level').textContent = Math.round(agentStatus.confidence) + '%';
                document.getElementById('decisions-count').textContent = agentStatus.decisions;
                
                console.log('üìä Using simulated data - Confidence:', agentStatus.confidence + '%, Decisions:', agentStatus.decisions);
            }
        }
        
        // Load real AI insights from API
        async function loadAIInsights() {
            try {
                const response = await fetch(`${API_BASE}/insights`);
                if (response.ok) {
                    const data = await response.json();
                    
                    const container = document.getElementById('ai-insights-container');
                    container.innerHTML = '';
                    
                    data.insights.forEach(insight => {
                        addAIInsightFromAPI(insight);
                    });
                    
                    console.log(`‚úÖ Loaded ${data.insights.length} real AI insights`);
                } else {
                    throw new Error(`API responded with status: ${response.status}`);
                }
            } catch (error) {
                console.log('‚ö†Ô∏è API unavailable, generating simulated insights:', error.message);
                
                // Generate realistic simulated insights
                const simulatedInsights = [
                    {
                        id: 'sim_' + Date.now(),
                        type: 'efficiency',
                        title: 'Line 3 Optimization',
                        message: 'Detected opportunity for 8.5% efficiency improvement by reducing changeover times.',
                        priority: 'high',
                        confidence: 0.87,
                        impact: 'production',
                        timestamp: new Date(Date.now() - Math.random() * 3600000).toISOString()
                    },
                    {
                        id: 'sim_' + (Date.now() + 1),
                        type: 'maintenance',
                        title: 'Predictive Maintenance',
                        message: 'Welding robot #7 requires calibration within 72 hours based on vibration patterns.',
                        priority: 'medium',
                        confidence: 0.92,
                        impact: 'quality',
                        timestamp: new Date(Date.now() - Math.random() * 1800000).toISOString()
                    },
                    {
                        id: 'sim_' + (Date.now() + 2),
                        type: 'quality',
                        title: 'Quality Improvement',
                        message: 'Temperature parameter adjustment would reduce defects by 12.3% based on historical data.',
                        priority: 'medium',
                        confidence: 0.79,
                        impact: 'quality',
                        timestamp: new Date(Date.now() - Math.random() * 900000).toISOString()
                    }
                ];
                
                const container = document.getElementById('ai-insights-container');
                container.innerHTML = '';
                
                simulatedInsights.forEach(insight => {
                    addAIInsightFromAPI(insight);
                });
                
                console.log(`üìä Generated ${simulatedInsights.length} simulated insights`);
            }
        }
        
        // Add AI insight from API data
        function addAIInsightFromAPI(insight) {
            const container = document.getElementById('ai-insights-container');
            const insightDiv = document.createElement('div');
            insightDiv.className = 'insight-card fade-in';
            insightDiv.innerHTML = `
                <div class="insight-header">
                    <div class="insight-title">${insight.title}</div>
                    <div class="insight-confidence">${insight.confidence}% confident</div>
                </div>
                <div class="insight-description">${insight.description}</div>
            `;
            
            container.appendChild(insightDiv);
        }
        
        // Update factory metrics
        function updateFactoryMetrics() {
            const oee = 92 + Math.random() * 4;
            const uptime = 96 + Math.random() * 3;
            const quality = 98 + Math.random() * 2;
            const efficiency = 94 + Math.random() * 4;
            
            document.getElementById('oee-metric').textContent = oee.toFixed(1) + '%';
            document.getElementById('uptime-metric').textContent = uptime.toFixed(1) + '%';
            document.getElementById('quality-metric').textContent = quality.toFixed(1) + '%';
            document.getElementById('efficiency-metric').textContent = efficiency.toFixed(1) + '%';
            
            // Update header status
            agentStatus.confidence = Math.min(98, Math.max(85, agentStatus.confidence + (Math.random() - 0.5) * 2));
            document.getElementById('confidence-level').textContent = Math.round(agentStatus.confidence) + '%';
        }
        
        // Update operations status
        function updateOperationsStatus() {
            const productionContainer = document.getElementById('production-status');
            const maintenanceContainer = document.getElementById('maintenance-queue');
            
            productionContainer.innerHTML = '';
            maintenanceContainer.innerHTML = '';
            
            factoryMachines.forEach(machine => {
                const machineDiv = document.createElement('div');
                machineDiv.className = `machine-status ${machine.status}`;
                machineDiv.innerHTML = `
                    <div>
                        <div class="machine-name">${machine.id}</div>
                        <div class="machine-metric">${machine.metric}</div>
                    </div>
                    <div style="text-align: right; font-size: 11px;">
                        ${machine.temp.toFixed(1)}¬∞C
                    </div>
                `;
                
                if (machine.status === 'operational') {
                    productionContainer.appendChild(machineDiv);
                } else {
                    maintenanceContainer.appendChild(machineDiv);
                }
            });
        }
        
        // Add AI insight
        function addAIInsight(title, description, confidence) {
            const container = document.getElementById('ai-insights-container');
            const insightDiv = document.createElement('div');
            insightDiv.className = 'insight-card fade-in';
            insightDiv.innerHTML = `
                <div class="insight-header">
                    <div class="insight-title">${title}</div>
                    <div class="insight-confidence">${confidence}% confident</div>
                </div>
                <div class="insight-description">${description}</div>
            `;
            
            container.insertBefore(insightDiv, container.firstChild);
            
            // Keep only last 5 insights
            while (container.children.length > 5) {
                container.removeChild(container.lastChild);
            }
        }
        
        // Tab switching
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName + '-tab').classList.add('active');
        }
        
        // Chat functionality with real API
        function handleChatInput(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }
        
        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            if (!message) return;
            
            addUserMessage(message);
            input.value = '';
            
            // Show typing indicator
            addTypingIndicator();
            
            try {
                // Send to real Copilot API
                const response = await fetch(`${API_BASE}/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: message,
                        userId: 'dashboard-user',
                        sessionId: generateSessionId()
                    })
                });
                
                removeTypingIndicator();
                
                if (response.ok) {
                    const data = await response.json();
                    addAgentMessage(data.response, data.confidence);
                    
                    // Update decisions counter
                    agentStatus.decisions++;
                    document.getElementById('decisions-count').textContent = agentStatus.decisions;
                } else {
                    throw new Error('API request failed');
                }
            } catch (error) {
                console.log('‚ö†Ô∏è API unavailable, generating simulated response:', error.message);
                removeTypingIndicator();
                
                // Fall back to intelligent local response
                const response = generateIntelligentResponse(message);
                addAgentMessage(response.message, response.confidence);
                
                // Update decisions counter (simulated)
                agentStatus.decisions++;
                document.getElementById('decisions-count').textContent = agentStatus.decisions;
            }
        }
        
        function sendQuickMessage(message) {
            document.getElementById('chat-input').value = message;
            sendMessage();
        }
        
        function addUserMessage(message) {
            const container = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message user fade-in';
            messageDiv.innerHTML = `
                <div class="message-header">You ‚Ä¢ Now</div>
                <div class="message-content">${message}</div>
            `;
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }
        
        function addAgentMessage(message, confidence = null) {
            const container = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message agent fade-in';
            
            let header = 'Factory Copilot ‚Ä¢ Now';
            if (confidence) {
                header += ` ‚Ä¢ ${Math.round(confidence)}% confidence`;
            }
            
            messageDiv.innerHTML = `
                <div class="message-header">${header}</div>
                <div class="message-content">${message}</div>
            `;
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }
        
        function addTypingIndicator() {
            const container = document.getElementById('chat-messages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message agent typing-indicator';
            typingDiv.id = 'typing-indicator';
            typingDiv.innerHTML = `
                <div class="message-header">Factory Copilot ‚Ä¢ Thinking...</div>
                <div class="message-content">
                    <span>‚óè</span><span>‚óè</span><span>‚óè</span>
                </div>
            `;
            container.appendChild(typingDiv);
            container.scrollTop = container.scrollHeight;
            
            // Add typing animation
            const dots = typingDiv.querySelectorAll('span');
            let i = 0;
            const typingAnimation = setInterval(() => {
                dots.forEach(dot => dot.style.opacity = '0.3');
                dots[i % dots.length].style.opacity = '1';
                i++;
            }, 500);
            
            typingDiv.dataset.animationId = typingAnimation;
        }
        
        function removeTypingIndicator() {
            const typingDiv = document.getElementById('typing-indicator');
            if (typingDiv) {
                clearInterval(typingDiv.dataset.animationId);
                typingDiv.remove();
            }
        }
        
        function generateSessionId() {
            return 'session_' + Math.random().toString(36).substr(2, 9);
        }
        
        function generateAIResponse(userMessage) {
            const message = userMessage.toLowerCase();
            
            // Preguntas espec√≠ficas sobre mantenimiento por l√≠nea
            if (message.includes('l√≠nea') || message.includes('linea')) {
                if (message.includes('mantenimiento') || message.includes('siguiente mantenimiento')) {
                    if (message.includes('1') || message.includes('uno')) {
                        return 'üîß **L√çNEA 1 - Pr√≥ximo Mantenimiento:**\n\nüìÖ **Programado para:** Ma√±ana 14:00 - 15:30\nü§ñ **M√°quinas:** LINE-1-ROBOT-01 (calibraci√≥n de precisi√≥n)\n‚ö° **Tipo:** Mantenimiento preventivo\n‚è±Ô∏è **Duraci√≥n estimada:** 90 minutos\nüë®‚Äçüîß **T√©cnico asignado:** Juan P√©rez\nüìã **Tareas:** Calibraci√≥n de brazos rob√≥ticos y verificaci√≥n de sensores\n\n¬øTe gustar√≠a que reprograme esta ventana de mantenimiento?';
                    }
                    if (message.includes('2') || message.includes('dos')) {
                        return 'üö® **L√çNEA 2 - Mantenimiento URGENTE:**\n\nüìÖ **Requerido:** HOY 16:00 (Cr√≠tico)\nüî• **M√°quinas:** LINE-2-CNC-02 (temperatura cr√≠tica 85¬∞C)\n‚ö†Ô∏è **Tipo:** Mantenimiento correctivo de emergencia\n‚è±Ô∏è **Duraci√≥n estimada:** 2-3 horas\nüë®‚Äçüîß **T√©cnico asignado:** Mar√≠a Gonz√°lez (especialista t√©rmico)\nüìã **Tareas:** Revisi√≥n sistema de refrigeraci√≥n, reemplazo de termostatos\nüí∞ **Costo de parada:** $1,200/hora\n\nü§ñ ¬øEjecuto el protocolo de parada de emergencia ahora?';
                    }
                    if (message.includes('3') || message.includes('tres')) {
                        return 'üîß **L√çNEA 3 - Pr√≥ximo Mantenimiento:**\n\nüìÖ **Programado para:** Viernes 09:00 - 11:00\n‚öôÔ∏è **M√°quinas:** LINE-3-CONV-03 (ajuste tensi√≥n de banda)\n‚ö° **Tipo:** Mantenimiento preventivo\n‚è±Ô∏è **Duraci√≥n estimada:** 120 minutos\nüë®‚Äçüîß **T√©cnico asignado:** Carlos Ruiz\nüìã **Tareas:** Ajuste tensi√≥n transportador, lubricaci√≥n rodamientos\nüìä **Eficiencia esperada:** +2.5% despu√©s del mantenimiento\n\n‚úÖ Esta l√≠nea est√° funcionando de manera √≥ptima.';
                    }
                    return 'üîß **Resumen de Mantenimiento por L√≠neas:**\n\n**L√çNEA 1:** Ma√±ana 14:00 (Preventivo - Robot)\n**L√çNEA 2:** ‚ö†Ô∏è HOY 16:00 (URGENTE - CNC temperatura)\n**L√çNEA 3:** Viernes 09:00 (Preventivo - Transportador)\n\n¬øSobre qu√© l√≠nea espec√≠fica te gustar√≠a m√°s detalles?';
                }
            }
            
            // Preguntas sobre cu√°ndo es el siguiente mantenimiento
            if ((message.includes('cuando') || message.includes('cu√°ndo')) && (message.includes('siguiente') || message.includes('pr√≥ximo')) && message.includes('mantenimiento')) {
                return 'üìÖ **Pr√≥ximos Mantenimientos Programados:**\n\nüö® **HOY 16:00** - LINE-2-CNC-02 (URGENTE)\n   ‚û§ Sistema de refrigeraci√≥n cr√≠tico\n   ‚û§ Duraci√≥n: 2-3 horas\n   ‚û§ T√©cnico: Mar√≠a Gonz√°lez\n\n‚è∞ **MA√ëANA 14:00** - LINE-1-ROBOT-01\n   ‚û§ Calibraci√≥n preventiva\n   ‚û§ Duraci√≥n: 90 minutos\n   ‚û§ T√©cnico: Juan P√©rez\n\nüìÜ **VIERNES 09:00** - LINE-3-CONV-03\n   ‚û§ Ajuste tensi√≥n transportador\n   ‚û§ Duraci√≥n: 120 minutos\n   ‚û§ T√©cnico: Carlos Ruiz\n\nü§ñ ¬øQuieres que ajuste alguna de estas programaciones?';
            }
            
            // Preguntas sobre l√≠neas espec√≠ficas
            if (message.includes('line-1') || (message.includes('l√≠nea') && message.includes('1'))) {
                return 'üè≠ **L√çNEA 1 - Estado Detallado:**\n\n‚úÖ **Estado:** Operacional (94% eficiencia)\nü§ñ **LINE-1-ROBOT-01:** 93% eficiencia, 61.4¬∞C\n‚öôÔ∏è **LINE-1-CNC-01:** 92% eficiencia, 68.2¬∞C\nüîÑ **LINE-1-CONV-01:** 98% eficiencia, 45.7¬∞C\n\nüìÖ **Pr√≥ximo mantenimiento:** Ma√±ana 14:00\nüìä **Calidad:** 99.8% (Mejor l√≠nea de la f√°brica)\n‚ö° **Consumo energ√©tico:** 78.5 kW (√ìptimo)\n\nüéØ **Recomendaci√≥n:** L√≠nea funcionando perfectamente. El mantenimiento preventivo de ma√±ana mejorar√° la precisi√≥n un 0.8% adicional.';
            }
            
            if (message.includes('line-2') || (message.includes('l√≠nea') && message.includes('2'))) {
                return 'üö® **L√çNEA 2 - ALERTA CR√çTICA:**\n\n‚ö†Ô∏è **Estado:** Cr√≠tico - Requiere atenci√≥n inmediata\nüî• **LINE-2-CNC-02:** 85¬∞C (CR√çTICO) - 78% eficiencia\nü§ñ **LINE-2-ROBOT-02:** 72.3¬∞C (Advertencia) - 78% eficiencia\nüîÑ **LINE-2-CONV-02:** 48.9¬∞C (Normal) - 96% eficiencia\n\nüö® **ACCI√ìN REQUERIDA:** Mantenimiento HOY 16:00\nüìâ **Impacto:** Producci√≥n reducida 22%\nüí∞ **Costo de parada:** $1,200/hora\n\nü§ñ **¬øEjecuto parada de emergencia ahora para prevenir da√±os mayores?**';
            }
            
            if (message.includes('line-3') || (message.includes('l√≠nea') && message.includes('3'))) {
                return 'üîß **L√çNEA 3 - Estado Bueno:**\n\n‚úÖ **Estado:** Operacional con mantenimiento pr√≥ximo\n‚öôÔ∏è **LINE-3-CNC-03:** 91% eficiencia, 66.8¬∞C\nü§ñ **LINE-3-ROBOT-03:** 93% eficiencia, 61.4¬∞C\n‚ö†Ô∏è **LINE-3-CONV-03:** Tensi√≥n baja detectada, 52.1¬∞C\n\nüìÖ **Pr√≥ximo mantenimiento:** Viernes 09:00\nüìä **Calidad:** 98.5% (Muy buena)\n‚ö° **Consumo energ√©tico:** 81.2 kW (Normal)\n\nüéØ **Recomendaci√≥n:** Funcionamiento estable. El ajuste del viernes resolver√° el tema de tensi√≥n del transportador.';
            }
            
            // Preguntas sobre producci√≥n y status
            if (message.includes('production') || message.includes('status') || message.includes('producci√≥n')) {
                return 'üìä **Estado General de Producci√≥n:**\n\nüè≠ **OEE Global:** 94.2%\nüìà **Eficiencia promedio:** 88.3%\n‚ö° **L√≠neas activas:** 3/3\n\n**Detalle por l√≠neas:**\n‚úÖ **L√çNEA 1:** 94% - √ìptima\nüö® **L√çNEA 2:** 78% - Cr√≠tica (Temp. alta)\n‚úÖ **L√çNEA 3:** 91% - Buena\n\nüéØ **Meta diaria:** 102% (En riesgo por L√çNEA 2)\nüì¶ **Producci√≥n actual:** 847 unidades/hora\nüéØ **Target:** 950 unidades/hora\n\nüí° **¬øQuieres an√°lisis detallado de alguna l√≠nea espec√≠fica?**';
            }
            
            if (message.includes('energy') || message.includes('optimize') || message.includes('energ√≠a')) {
                return '‚ö° **Optimizaci√≥n Energ√©tica:**\n\nüìä **Consumo actual:** 237.2 kW\nüí∞ **Costo por hora:** $28.46\nüìà **Eficiencia energ√©tica:** 89.3%\n\n**Oportunidades detectadas:**\nüî• **L√çNEA 2:** +15% consumo por sobrecalentamiento\n‚ö° **Horario pico:** Reducir 12% ajustando turnos\nü§ñ **Standby inteligente:** Ahorrar $2,400/d√≠a\n\nüéØ **Implementar optimizaci√≥n autom√°tica?**\n‚úÖ Sin impacto en producci√≥n\nüí∞ Ahorro estimado: $876/d√≠a';
            }
            
            if (message.includes('quality') || message.includes('calidad')) {
                return '‚ú® **M√©tricas de Calidad:**\n\nüéØ **Score global:** 99.3% (Excelente)\nüìä **First Pass Yield:** 94.7%\nüîç **Defectos/hora:** 0.7%\n\n**Por l√≠neas:**\nüåü **L√çNEA 1:** 99.8% (¬°Perfecto!)\n‚ö†Ô∏è **L√çNEA 2:** 97.1% (Afectada por temperatura)\n‚úÖ **L√çNEA 3:** 98.5% (Muy buena)\n\nüîß **Correlaci√≥n detectada:** La temperatura alta de L√çNEA 2 est√° afectando la calidad en 2.2%\n\nüí° **Recomendaci√≥n:** Despu√©s del mantenimiento t√©rmico, calidad deber√≠a subir a 99.5%';
            }
            
            if (message.includes('diagnostic') || message.includes('help') || message.includes('ayuda')) {
                return 'ü©∫ **Centro de Ayuda - Smart Factory Copilot:**\n\n**Preguntas que puedo responder:**\nüè≠ "¬øEn qu√© l√≠nea tengo el siguiente mantenimiento?"\nüìÖ "¬øCu√°ndo es el pr√≥ximo mantenimiento?"\n‚öôÔ∏è "¬øC√≥mo est√° la L√çNEA 2?"\nüìä "¬øCu√°l es el estado de producci√≥n?"\n‚ö° "¬øC√≥mo optimizar el consumo energ√©tico?"\n‚ú® "¬øC√≥mo est√°n las m√©tricas de calidad?"\n\n**Comandos √∫tiles:**\nüîß "Ejecutar mantenimiento de emergencia"\n‚ö° "Optimizar consumo energ√©tico"\nüìä "Mostrar an√°lisis predictivo"\nü§ñ "Calibrar robots autom√°ticamente"\n\nüí¨ **Habla conmigo en lenguaje natural - Entiendo espa√±ol perfectamente!**';
            }
            
            return 'ü§ñ Entiendo tu consulta. Puedo ayudarte con informaci√≥n espec√≠fica sobre:\n\nüîß **Mantenimiento:** "¬øCu√°ndo es el siguiente mantenimiento de L√çNEA 2?"\nüè≠ **L√≠neas:** "¬øC√≥mo est√° funcionando L√çNEA 1?"\nüìä **Producci√≥n:** "¬øCu√°l es el estado actual de producci√≥n?"\n‚ö° **Energ√≠a:** "¬øC√≥mo optimizar el consumo?"\n‚ú® **Calidad:** "¬øC√≥mo est√°n las m√©tricas de calidad?"\n\nüí¨ **Hazme preguntas espec√≠ficas y te dar√© respuestas detalladas con datos reales de la f√°brica.**';
        }
        
        // Generate intelligent responses when API is not available
        function generateIntelligentResponse(userMessage) {
            const message = userMessage.toLowerCase();
            
            // Response patterns with confidence levels
            const responses = [
                {
                    keywords: ['status', 'state', 'how is', 'situation', 'estado', 'como esta'],
                    response: 'üìä **Current Factory Status:**\n\n‚Ä¢ **Overall efficiency:** 91.7%\n‚Ä¢ **Production lines:** 4/4 operational\n‚Ä¢ **Active predictions:** 23 maintenance insights\n‚Ä¢ **Quality:** 99.2% within parameters\n‚Ä¢ **Next recommended action:** Calibrate Robot #7 in 72hrs',
                    confidence: 0.95
                },
                {
                    keywords: ['maintenance', 'repair', 'fix', 'fallo', 'mantenimiento', 'reparar'],
                    response: 'üîß **Maintenance Analysis:**\n\n‚Ä¢ **Predictive maintenance active** for 12 equipment units\n‚Ä¢ **Welding robot #7**: Requires calibration (Priority: Medium)\n‚Ä¢ **Line 3**: Changeover time optimization recommended\n‚Ä¢ **Next maintenance window**: Tuesday 2:00-4:00 PM\n\n**Would you like me to schedule any specific action?**',
                    confidence: 0.88
                },
                {
                    keywords: ['efficiency', 'optimize', 'improve', 'performance', 'eficiencia', 'optimizar', 'mejorar'],
                    response: '‚ö° **Optimization Opportunities:**\n\n‚Ä¢ **Line 3**: Potential 8.5% improvement by reducing changeover times\n‚Ä¢ **Energy consumption**: 12% savings by adjusting peak hour schedules\n‚Ä¢ **Welding robot**: Calibration would improve precision by 0.8%\n‚Ä¢ **Assembly line**: Optimized sequence would reduce 4 min/cycle\n\n**Should I implement any of these optimizations?**',
                    confidence: 0.91
                },
                {
                    keywords: ['quality', 'defects', 'problems', 'calidad', 'problemas'],
                    response: 'üéØ **Quality Monitoring:**\n\n‚Ä¢ **Overall index**: 99.2% (‚ÜóÔ∏è +0.3% vs. yesterday)\n‚Ä¢ **Defects detected**: 3 in last 24h (automatically corrected)\n‚Ä¢ **Critical parameter**: Line 2 temperature needs minor adjustment\n‚Ä¢ **Prediction**: Adjustment would reduce additional defects by 12.3%\n\n**Recommendation:** Apply temperature adjustment automatically.',
                    confidence: 0.86
                },
                {
                    keywords: ['production', 'output', 'volume', 'targets', 'produccion'],
                    response: 'üìà **Production Status:**\n\n‚Ä¢ **Daily target**: 847/950 units (89.2%)\n‚Ä¢ **Current speed**: 42 units/hour\n‚Ä¢ **Time remaining**: 2.5 hours to complete target\n‚Ä¢ **Efficiency by line**: L1(94%), L2(91%), L3(87%), L4(93%)\n\n**Suggested action:** Optimize Line 3 to reach daily target.',
                    confidence: 0.92
                },
                {
                    keywords: ['energy', 'consumption', 'costs', 'energia', 'consumo', 'costos'],
                    response: 'üîã **Energy Analysis:**\n\n‚Ä¢ **Current consumption**: 234 kWh/hour (-8% vs average)\n‚Ä¢ **Peak demand**: 2:30-4:00 PM (highest cost period)\n‚Ä¢ **Savings opportunity**: Reschedule non-critical operations\n‚Ä¢ **Potential savings**: $1,200 USD/month with smart optimization\n\n**Activate energy optimization mode?**',
                    confidence: 0.89
                },
                {
                    keywords: ['help', 'functions', 'capabilities', 'what can', 'ayuda', 'que puedes', 'funciones'],
                    response: 'ü§ñ **Copilot Capabilities:**\n\n‚Ä¢ **Real-time monitoring** of 4 production lines\n‚Ä¢ **Predictive maintenance** with advanced AI\n‚Ä¢ **Automatic process optimization** and energy management\n‚Ä¢ **Quality control** with computer vision\n‚Ä¢ **Efficiency analysis** and recommendations\n‚Ä¢ **Smart maintenance scheduling**\n\n**Useful commands:** "status", "optimize", "maintenance", "quality"',
                    confidence: 0.97
                }
            ];
            
            // Find best matching response
            let bestMatch = null;
            let maxMatches = 0;
            
            for (const pattern of responses) {
                const matches = pattern.keywords.filter(keyword => message.includes(keyword)).length;
                if (matches > maxMatches) {
                    maxMatches = matches;
                    bestMatch = pattern;
                }
            }
            
            // Default response if no match found
            if (!bestMatch || maxMatches === 0) {
                const defaultResponses = [
                    {
                        response: 'ü§ñ I\'m analyzing your query with current factory data. **Current context:**\n\n‚Ä¢ 4 production lines at 91.7% efficiency\n‚Ä¢ 23 active predictive maintenance insights\n‚Ä¢ Last optimization: 2.5 hours ago\n\n**Could you be more specific about which aspect you\'d like to review?**',
                        confidence: 0.75
                    },
                    {
                        response: 'üìä Based on real-time data, everything is operating within normal parameters. **Quick summary:**\n\n‚Ä¢ No critical alerts\n‚Ä¢ Production on target (89.2%)\n‚Ä¢ Quality stable (99.2%)\n\n**Would you like to review any specific system or explore improvement opportunities?**',
                        confidence: 0.73
                    }
                ];
                
                bestMatch = defaultResponses[Math.floor(Math.random() * defaultResponses.length)];
            }
            
            return {
                message: bestMatch.response,
                confidence: bestMatch.confidence
            };
        }
        
        // Start real-time updates
        function startRealTimeUpdates() {
            // Update metrics every 30 seconds
            setInterval(updateFactoryMetrics, 30000);
            
            // Update operations every 15 seconds
            setInterval(updateOperationsStatus, 15000);
            
            // Refresh AI insights every 2 minutes
            setInterval(async () => {
                try {
                    await loadAIInsights();
                } catch (error) {
                    console.error('‚ùå Error updating insights:', error);
                    // Fall back to generating local insights
                    const insights = [
                        ['üîÆ Predictive Alert', 'Vibration pattern suggests bearing replacement needed within 72 hours', 89],
                        ['‚ö° Efficiency Opportunity', 'Production schedule optimization could increase throughput by 3.2%', 92],
                        ['üí∞ Cost Reduction', 'Alternative maintenance timing could save $1,800 in overtime costs', 87],
                        ['üéØ Quality Enhancement', 'Temperature control adjustment could improve quality by 1.1%', 94],
                        ['üîß Preventive Action', 'Lubrication cycle adjustment recommended for optimal performance', 91]
                    ];
                    
                    const randomInsight = insights[Math.floor(Math.random() * insights.length)];
                    addAIInsight(randomInsight[0], randomInsight[1], randomInsight[2]);
                }
            }, 120000);
            
            // Refresh Copilot status every 5 minutes
            setInterval(async () => {
                try {
                    await loadCopilotStatus();
                } catch (error) {
                    console.error('‚ùå Error updating Copilot status:', error);
                }
            }, 300000);
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initializeCopilot);
    
// Enhanced error handling for Azure endpoints
function handleAzureAPIError(error, fallback = null) {
    console.warn('Azure API Error:', error);
    if (fallback && typeof fallback === 'function') {
        return fallback();
    }
    return {
        error: true,
        message: 'Azure API temporarily unavailable',
        timestamp: new Date().toISOString(),
        source: 'fallback'
    };
}

// Enhanced fetch with retry logic
async function fetchWithRetry(url, options = {}, retries = 3) {
    for (let i = 0; i < retries; i++) {
        try {
            const response = await fetch(url, {
                ...options,
                timeout: 10000
            });
            
            if (response.ok) {
                return await response.json();
            } else {
                throw new Error(HTTP : );
            }
        } catch (error) {
            console.warn(Attempt  failed:, error.message);
            if (i === retries - 1) throw error;
            await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1))); // Progressive delay
        }
    }
}

// Enhanced error handling for Azure endpoints
function handleAzureAPIError(error, fallback = null) {
    console.warn('Azure API Error:', error);
    if (fallback && typeof fallback === 'function') {
        return fallback();
    }
    return {
        error: true,
        message: 'Azure API temporarily unavailable',
        timestamp: new Date().toISOString(),
        source: 'fallback'
    };
}

// Enhanced fetch with retry logic
async function fetchWithRetry(url, options = {}, retries = 3) {
    for (let i = 0; i < retries; i++) {
        try {
            const response = await fetch(url, {
                ...options,
                timeout: 10000
            });
            
            if (response.ok) {
                return await response.json();
            } else {
                throw new Error(HTTP : );
            }
        } catch (error) {
            console.warn(Attempt  failed:, error.message);
            if (i === retries - 1) throw error;
            await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1))); // Progressive delay
        }
    }
}
</script>

<!-- Enhanced Azure ML API Error Handling -->
<script>
const AZURE_ML_CONFIG = {
    endpoint: 'https://smartfactory-ml-api.azurewebsites.net',
    useRealModels: true,
    fallbackEnabled: true,
    retryAttempts: 3
};
// Global configuration for Azure ML APIs
const AZURE_CONFIG = {
    baseUrl: 'https://smartfactory-ml-api.azurewebsites.net',
    timeout: 15000,
    maxRetries: 3,
    retryDelay: 1000
};

// Enhanced fetch with retry logic for Azure APIs
async function fetchAzureMLAPI(endpoint, options = {}) {
    const url = AZURE_CONFIG.baseUrl + endpoint;
    
    for (let attempt = 1; attempt <= AZURE_CONFIG.maxRetries; attempt++) {
        try {
            console.log(üîÑ Attempt /: https://smartfactory-ml-api.azurewebsites.net/api/ml/anomaly?deviceId=TEST&temperature=75&real=true);
            
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), AZURE_CONFIG.timeout);
            
            const response = await fetch(url, {
                ...options,
                signal: controller.signal,
                headers: {
                    'Content-Type': 'application/json',
                    ...options.headers
                }
            });
            
            clearTimeout(timeoutId);
            
            if (response.ok) {
                const data = await response.json();
                console.log(‚úÖ Success: https://smartfactory-ml-api.azurewebsites.net/api/ml/anomaly?deviceId=TEST&temperature=75&real=true, data);
                return data;
            } else {
                throw new Error(HTTP : );
            }
            
        } catch (error) {
            console.warn(‚ö†Ô∏è Attempt  failed for https://smartfactory-ml-api.azurewebsites.net/api/ml/anomaly?deviceId=TEST&temperature=75&real=true:, error.message);
            
            if (attempt === AZURE_CONFIG.maxRetries) {
                console.error(‚ùå All attempts failed for https://smartfactory-ml-api.azurewebsites.net/api/ml/anomaly?deviceId=TEST&temperature=75&real=true);
                return generateFallbackData(endpoint, error);
            }
            
            // Progressive delay between retries
            await new Promise(resolve => setTimeout(resolve, AZURE_CONFIG.retryDelay * attempt));
        }
    }
}

// Generate fallback data when Azure API is unavailable
function generateFallbackData(endpoint, error) {
    const deviceId = new URLSearchParams(endpoint.split('?')[1] || '').get('deviceId') || 'UNKNOWN';
    const timestamp = new Date().toISOString();
    
    console.log(üîÑ Generating fallback data for https://smartfactory-ml-api.azurewebsites.net/api/ml/anomaly?deviceId=TEST&temperature=75&real=true);
    
    if (endpoint.includes('/ml/maintenance')) {
        return {
            deviceId,
            prediction: 'maintenance_ok',
            confidence: 0.65,
            riskScore: 0.3,
            estimatedDays: 25,
            modelType: 'fallback',
            timestamp,
            fallback: true,
            error: error.message
        };
    } else if (endpoint.includes('/ml/quality')) {
        return {
            deviceId,
            qualityGrade: 'B',
            qualityScore: 82,
            confidence: 0.70,
            defectProbability: 0.18,
            modelType: 'fallback',
            timestamp,
            fallback: true,
            error: error.message
        };
    } else if (endpoint.includes('/ml/energy')) {
        return {
            deviceId,
            currentEfficiency: 78,
            optimizedEfficiency: 85,
            potentialSavings: 7,
            recommendations: ['Azure API unavailable - using cached data'],
            modelType: 'fallback',
            timestamp,
            fallback: true,
            error: error.message
        };
    } else if (endpoint.includes('/ml/anomaly')) {
        return {
            deviceId,
            isAnomaly: false,
            anomalyScore: 0.25,
            confidence: 0.68,
            severity: 'low',
            detectedAnomalies: [],
            modelType: 'fallback',
            timestamp,
            fallback: true,
            error: error.message
        };
    }
    
    return { 
        error: true, 
        message: 'Service temporarily unavailable', 
        fallback: true,
        timestamp 
    };
}

// Update UI to show when using Azure vs fallback data
function updateDataSourceIndicator(data, elementId = null) {
    const isAzure = !data.fallback;
    const indicator = document.getElementById('data-source-indicator') || createDataSourceIndicator();
    
    indicator.innerHTML = 
        <div class="data-source ">
            <span class="indicator ">‚óè</span>
            
            <small></small>
        </div>
    ;
}

function createDataSourceIndicator() {
    const indicator = document.createElement('div');
    indicator.id = 'data-source-indicator';
    indicator.style.cssText = 
        position: fixed; 
        top: 10px; 
        right: 10px; 
        background: rgba(0,0,0,0.8); 
        color: white; 
        padding: 8px 12px; 
        border-radius: 4px; 
        font-size: 12px; 
        z-index: 1000;
        font-family: monospace;
    ;
    document.body.appendChild(indicator);
    return indicator;
}

// Override original fetch calls to use enhanced version
const originalFetch = window.fetch;
window.fetch = function(url, options) {
    if (typeof url === 'string' && url.includes('/api/ml/')) {
        const endpoint = new URL(url).pathname + new URL(url).search;
        return fetchAzureMLAPI(endpoint, options);
    }
    return originalFetch.call(this, url, options);
};

console.log('üöÄ Enhanced Azure ML API integration loaded');
console.log('üìç Azure Function URL:', AZURE_CONFIG.baseUrl);
</script>
</body>
</html>


