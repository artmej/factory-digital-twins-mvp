<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ§ª Architecture Integration Test - Smart Factory</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .test-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .test-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .test-status {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .status-pending {
            background: rgba(255, 193, 7, 0.3);
            color: #ffc107;
        }

        .status-success {
            background: rgba(40, 167, 69, 0.3);
            color: #28a745;
        }

        .status-error {
            background: rgba(220, 53, 69, 0.3);
            color: #dc3545;
        }

        .test-details {
            font-size: 0.9em;
            line-height: 1.6;
        }

        .test-results {
            margin-top: 15px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            border-left: 4px solid #00ff88;
        }

        .test-button {
            background: linear-gradient(135deg, #00ff88, #00d4ff);
            color: #1e3c72;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            margin: 10px 10px 10px 0;
            transition: all 0.3s ease;
        }

        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 255, 136, 0.3);
        }

        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            margin-top: 30px;
        }

        .architecture-diagram {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            font-family: monospace;
            font-size: 0.9em;
            line-height: 1.8;
            border-left: 4px solid #00ff88;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #00ff88;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ§ª Architecture Integration Test Suite</h1>
            <p>Validating Application Gateway + Function Apps + WebApps architecture across all dashboards</p>
        </div>

        <div class="test-grid" id="testGrid">
            <!-- Test cards will be dynamically generated -->
        </div>

        <div class="test-controls">
            <button class="test-button" onclick="runAllTests()">ğŸš€ Run All Architecture Tests</button>
            <button class="test-button" onclick="testSpecificDashboard()">ğŸ¯ Test Specific Dashboard</button>
            <button class="test-button" onclick="validateAzureEndpoints()">â˜ï¸ Validate Azure Endpoints</button>
            <button class="test-button" onclick="exportReport()">ğŸ“‹ Export Test Report</button>
        </div>

        <div class="summary-card" id="summaryCard" style="display: none;">
            <h3>ğŸ“Š Test Results Summary</h3>
            <div id="summaryContent"></div>
        </div>

        <div class="architecture-diagram">
            <h3>ğŸ—ï¸ Expected Architecture Pattern</h3>
            <pre>
ğŸŒ Application Gateway (smartfactory-gw.azurefd.net)
    â†“
ğŸ“± Function Apps (Middleware Layer)
    â”œâ”€â”€ Auth Function   (smartfactory-auth-func.azurewebsites.net)
    â”œâ”€â”€ Data Function   (smartfactory-data-func.azurewebsites.net)  
    â”œâ”€â”€ ML Function     (smartfactory-ml-func.azurewebsites.net)
    â””â”€â”€ IoT Function    (smartfactory-iot-func.azurewebsites.net)
    â†“
ğŸ—ï¸ WebApp APIs (Backend Layer)
    â”œâ”€â”€ ML API          (smartfactoryml-api.azurewebsites.net)
    â”œâ”€â”€ Cosmos API      (smartfactory-cosmos-api.azurewebsites.net)
    â”œâ”€â”€ Digital Twins   (smartfactory-dt-api.azurewebsites.net)
    â””â”€â”€ Main API        (smartfactory-prod-web.azurewebsites.net)
            </pre>
        </div>
    </div>

    <script>
        // Dashboard configurations to test
        const dashboards = [
            { 
                name: '3D Dashboard', 
                file: '3d-dashboard.html',
                icon: 'ğŸ®',
                description: 'Interactive 3D factory visualization with real-time ML data'
            },
            { 
                name: 'Executive Dashboard', 
                file: 'executive-dashboard.html',
                icon: 'ğŸ’¼',
                description: 'High-level KPIs and business metrics for executives'
            },
            { 
                name: 'Maintenance Dashboard', 
                file: 'maintenance-dashboard.html',
                icon: 'ğŸ”§',
                description: 'Predictive maintenance with ML-driven insights'
            },
            { 
                name: 'Mobile Dashboard', 
                file: 'mobile-dashboard.html',
                icon: 'ğŸ“±',
                description: 'Touch-optimized interface for mobile devices'
            },
            { 
                name: 'Copilot Dashboard', 
                file: 'copilot-dashboard.html',
                icon: 'ğŸ¤–',
                description: 'AI-powered chat assistant for factory operations'
            },
            { 
                name: 'Test Dashboard', 
                file: 'test-dashboard.html',
                icon: 'ğŸ§ª',
                description: 'Comprehensive testing interface for API validation'
            },
            { 
                name: 'Simple Dashboard', 
                file: 'simple.html',
                icon: 'ğŸ“Š',
                description: 'Streamlined production monitoring interface'
            },
            { 
                name: 'Main Index', 
                file: 'index.html',
                icon: 'ğŸ ',
                description: 'Landing page with dashboard navigation'
            }
        ];

        // Expected architecture configuration
        const expectedArchitecture = {
            gateway: "https://smartfactory-gw.azurefd.net",
            functions: {
                auth: "https://smartfactory-auth-func.azurewebsites.net",
                data: "https://smartfactory-data-func.azurewebsites.net",
                ml: "https://smartfactory-ml-func.azurewebsites.net",
                iot: "https://smartfactory-iot-func.azurewebsites.net"
            },
            webApps: {
                mlAPI: "https://smartfactoryml-api.azurewebsites.net",
                cosmosAPI: "https://smartfactory-cosmos-api.azurewebsites.net",
                digitalTwinsAPI: "https://smartfactory-dt-api.azurewebsites.net",
                mainAPI: "https://smartfactory-prod-web.azurewebsites.net"
            }
        };

        // Test results storage
        let testResults = {};

        // Initialize test grid
        function initializeTestGrid() {
            const grid = document.getElementById('testGrid');
            
            dashboards.forEach(dashboard => {
                const card = document.createElement('div');
                card.className = 'test-card';
                card.innerHTML = `
                    <div class="test-header">
                        <h3>${dashboard.icon} ${dashboard.name}</h3>
                        <div class="test-status status-pending" id="status-${dashboard.file}">
                            <span class="loading"></span> Pending
                        </div>
                    </div>
                    <div class="test-details">
                        <p><strong>File:</strong> ${dashboard.file}</p>
                        <p><strong>Purpose:</strong> ${dashboard.description}</p>
                        <button class="test-button" onclick="testSingleDashboard('${dashboard.file}')">
                            ğŸ§ª Test Architecture
                        </button>
                    </div>
                    <div class="test-results" id="results-${dashboard.file}" style="display: none;">
                        <div id="details-${dashboard.file}"></div>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        // Test single dashboard by creating iframe and checking architecture
        async function testSingleDashboard(filename) {
            const statusElement = document.getElementById(`status-${filename}`);
            const resultsElement = document.getElementById(`results-${filename}`);
            const detailsElement = document.getElementById(`details-${filename}`);
            
            statusElement.className = 'test-status status-pending';
            statusElement.innerHTML = '<span class="loading"></span> Testing...';
            resultsElement.style.display = 'block';
            
            try {
                // Create hidden iframe to load and test dashboard
                const iframe = document.createElement('iframe');
                iframe.style.display = 'none';
                iframe.src = filename;
                document.body.appendChild(iframe);

                // Wait for iframe to load
                await new Promise((resolve, reject) => {
                    iframe.onload = resolve;
                    iframe.onerror = reject;
                    setTimeout(reject, 10000); // 10 second timeout
                });

                // Test architecture configuration in iframe
                const iframeWindow = iframe.contentWindow;
                const tests = [];
                
                // Check if AZURE_ARCHITECTURE exists
                if (iframeWindow.AZURE_ARCHITECTURE) {
                    tests.push('âœ… AZURE_ARCHITECTURE object found');
                    
                    // Check gateway configuration
                    if (iframeWindow.AZURE_ARCHITECTURE.gateway) {
                        tests.push(`âœ… Gateway: ${iframeWindow.AZURE_ARCHITECTURE.gateway}`);
                    } else {
                        tests.push('âš ï¸ Gateway: Development mode (null)');
                    }
                    
                    // Check function apps
                    const functions = iframeWindow.AZURE_ARCHITECTURE.functions || {};
                    const functionTests = Object.keys(expectedArchitecture.functions).map(key => {
                        if (functions[key]) {
                            return `âœ… Function ${key}: ${functions[key]}`;
                        } else {
                            return `âš ï¸ Function ${key}: Development mode (null)`;
                        }
                    });
                    tests.push(...functionTests);
                    
                    // Check WebApp APIs
                    const webApps = iframeWindow.AZURE_ARCHITECTURE.webApps || {};
                    const webAppTests = Object.keys(expectedArchitecture.webApps).map(key => {
                        if (webApps[key]) {
                            return `âœ… WebApp ${key}: ${webApps[key]}`;
                        } else {
                            return `âš ï¸ WebApp ${key}: Not configured`;
                        }
                    });
                    tests.push(...webAppTests);
                    
                    // Check environment detection
                    if (iframeWindow.IS_DEVELOPMENT !== undefined) {
                        tests.push(`âœ… Environment detection: ${iframeWindow.IS_DEVELOPMENT ? 'Development' : 'Production'}`);
                    } else {
                        tests.push('âŒ Environment detection: Missing');
                    }
                    
                    // Check authentication
                    if (iframeWindow.msalConfig) {
                        tests.push(`âœ… MSAL Auth: Client ID ${iframeWindow.msalConfig.auth.clientId.substring(0, 8)}...`);
                    } else {
                        tests.push('âŒ MSAL Auth: Not configured');
                    }
                    
                } else {
                    tests.push('âŒ AZURE_ARCHITECTURE object missing');
                }

                // Update test results
                const hasErrors = tests.some(test => test.startsWith('âŒ'));
                const hasWarnings = tests.some(test => test.startsWith('âš ï¸'));
                
                if (hasErrors) {
                    statusElement.className = 'test-status status-error';
                    statusElement.textContent = 'âŒ Failed';
                } else if (hasWarnings) {
                    statusElement.className = 'test-status status-success';
                    statusElement.textContent = 'âš ï¸ Dev Mode';
                } else {
                    statusElement.className = 'test-status status-success';
                    statusElement.textContent = 'âœ… Passed';
                }
                
                detailsElement.innerHTML = `
                    <strong>Architecture Test Results:</strong><br>
                    ${tests.join('<br>')}
                    <br><br>
                    <strong>Test completed at:</strong> ${new Date().toLocaleTimeString()}
                `;
                
                testResults[filename] = {
                    status: hasErrors ? 'error' : 'success',
                    tests: tests,
                    timestamp: new Date().toISOString()
                };
                
                // Cleanup
                document.body.removeChild(iframe);
                
            } catch (error) {
                statusElement.className = 'test-status status-error';
                statusElement.textContent = 'âŒ Error';
                detailsElement.innerHTML = `
                    <strong>Test Error:</strong><br>
                    ${error.message}<br>
                    <em>Dashboard may have loading issues or missing architecture</em>
                `;
                
                testResults[filename] = {
                    status: 'error',
                    error: error.message,
                    timestamp: new Date().toISOString()
                };
            }
        }

        // Run all tests
        async function runAllTests() {
            const summaryCard = document.getElementById('summaryCard');
            summaryCard.style.display = 'none';
            
            console.log('ğŸš€ Starting comprehensive architecture validation...');
            
            // Reset all status indicators
            dashboards.forEach(dashboard => {
                const statusElement = document.getElementById(`status-${dashboard.file}`);
                statusElement.className = 'test-status status-pending';
                statusElement.innerHTML = '<span class="loading"></span> Queued...';
            });
            
            // Test each dashboard sequentially to avoid overwhelming the browser
            for (const dashboard of dashboards) {
                await testSingleDashboard(dashboard.file);
                await new Promise(resolve => setTimeout(resolve, 1000)); // 1 second delay between tests
            }
            
            // Show summary
            showTestSummary();
        }

        // Show test summary
        function showTestSummary() {
            const summaryCard = document.getElementById('summaryCard');
            const summaryContent = document.getElementById('summaryContent');
            
            const totalTests = Object.keys(testResults).length;
            const passedTests = Object.values(testResults).filter(r => r.status === 'success').length;
            const failedTests = Object.values(testResults).filter(r => r.status === 'error').length;
            
            const successRate = Math.round((passedTests / totalTests) * 100);
            
            summaryContent.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin: 20px 0;">
                    <div>
                        <h4>ğŸ“Š Total Tests</h4>
                        <div style="font-size: 2em; color: #00ff88;">${totalTests}</div>
                    </div>
                    <div>
                        <h4>âœ… Passed</h4>
                        <div style="font-size: 2em; color: #28a745;">${passedTests}</div>
                    </div>
                    <div>
                        <h4>âŒ Failed</h4>
                        <div style="font-size: 2em; color: #dc3545;">${failedTests}</div>
                    </div>
                </div>
                <div style="margin: 20px 0;">
                    <h4>ğŸ¯ Architecture Integration Success Rate</h4>
                    <div style="font-size: 3em; color: ${successRate > 80 ? '#28a745' : successRate > 50 ? '#ffc107' : '#dc3545'};">${successRate}%</div>
                </div>
                <div style="text-align: left; background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px;">
                    <strong>âœ… Integration Status:</strong> ${successRate === 100 ? 'All dashboards have consistent Azure architecture' : 'Some dashboards need architecture updates'}<br>
                    <strong>ğŸ—ï¸ Architecture Pattern:</strong> Application Gateway + Function Apps + WebApps<br>
                    <strong>ğŸ”’ Environment Detection:</strong> All dashboards support dev/production modes<br>
                    <strong>ğŸ• Test Completed:</strong> ${new Date().toLocaleString()}
                </div>
            `;
            
            summaryCard.style.display = 'block';
        }

        // Test specific dashboard
        function testSpecificDashboard() {
            const filename = prompt("Enter dashboard filename (e.g., '3d-dashboard.html'):");
            if (filename && dashboards.find(d => d.file === filename)) {
                testSingleDashboard(filename);
            } else {
                alert("Invalid filename. Please use one of the following:\n" + 
                      dashboards.map(d => d.file).join('\n'));
            }
        }

        // Validate Azure endpoints
        async function validateAzureEndpoints() {
            alert("ğŸ”§ Azure endpoint validation requires production environment.\n" +
                  "This test validates that all architecture URLs are reachable.\n" +
                  "Currently in development mode - endpoints will show as null.");
        }

        // Export test report
        function exportReport() {
            const report = {
                testSuite: 'Smart Factory Architecture Integration',
                timestamp: new Date().toISOString(),
                environment: window.location.hostname,
                expectedArchitecture: expectedArchitecture,
                testResults: testResults,
                summary: {
                    totalTests: Object.keys(testResults).length,
                    passedTests: Object.values(testResults).filter(r => r.status === 'success').length,
                    failedTests: Object.values(testResults).filter(r => r.status === 'error').length
                }
            };
            
            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `smart-factory-architecture-test-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Initialize on page load
        window.addEventListener('load', () => {
            initializeTestGrid();
            console.log('ğŸ§ª Architecture Integration Test Suite loaded');
            console.log('Ready to validate Application Gateway + Function Apps + WebApps architecture');
        });
    </script>
</body>
</html>