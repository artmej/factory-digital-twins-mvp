<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üè≠ Smart Factory 3D - Sistema de Producci√≥n</title>
    
    <!-- Microsoft Authentication Library -->
    <script src="https://alcdn.msauth.net/browser/2.30.0/js/msal-browser.min.js"></script>
    
    <!-- Three.js CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            overflow: hidden;
            color: white;
        }
        
        #container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }
        
        #threejs-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        /* Enhanced HUD */
        #hud {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 100;
            background: rgba(0, 0, 0, 0.9);
            padding: 25px;
            border-radius: 15px;
            border: 2px solid #00ff88;
            min-width: 380px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        .hud-title {
            font-size: 18px;
            font-weight: bold;
            color: #00ff88;
            margin-bottom: 15px;
        }
        
        .user-info {
            background: rgba(0, 120, 215, 0.1);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #0078d4;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        #login-btn {
            font-size: 11px;
            padding: 5px 10px;
            background: #0078d4;
            color: white;
            border: none;
            border-radius: 15px;
            cursor: pointer;
        }
        
        .metric {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            font-size: 15px;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .metric-label {
            color: #ccc;
            font-weight: 500;
        }
        
        .metric-value {
            color: #fff;
            font-weight: bold;
        }
        
        .metric-value.good { color: #00ff88; }
        .metric-value.warning { color: #ffd93d; }
        .metric-value.critical { color: #ff6b6b; }
        
        /* Azure Status Indicator */
        #azure-status {
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 100;
            background: rgba(0, 0, 0, 0.85);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #0078d4;
            font-size: 12px;
            min-width: 280px;
        }
        
        .connection-info {
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        
        .status-details {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }
        
        .status-details small {
            color: #ccc;
            font-size: 10px;
        }
        
        .azure-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        
        .azure-indicator.online {
            background: #00ff88;
            box-shadow: 0 0 5px #00ff88;
        }
        
        .azure-indicator.offline {
            background: #ff6b6b;
        }
        
        /* Bottom Controls */
        #controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            display: flex;
            gap: 15px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px 25px;
            border-radius: 25px;
            border: 1px solid #00ff88;
        }
        
        .control-btn {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
            border: 1px solid #00ff88;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }
        
        .control-btn:hover {
            background: rgba(0, 255, 136, 0.4);
            transform: translateY(-2px);
        }
        
        .control-btn.active {
            background: #00ff88;
            color: #000;
        }
        
        /* Loading Screen */
        #loading {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            color: white;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(0, 255, 136, 0.3);
            border-left: 4px solid #00ff88;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .factory-explanation {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 50;
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #00ff88;
            display: none;
            max-width: 400px;
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="threejs-container"></div>
        
        <div id="loading">
            <div class="spinner"></div>
            <h3>üè≠ Cargando Smart Factory...</h3>
            <p>Conectando con Azure ML Services...</p>
        </div>
        
        <div id="hud">
            <div class="hud-title">
                üè≠ Smart Factory 3D - Sistema de Producci√≥n
            </div>
            <div class="user-info">
                üë§ <span id="user-name">Invitado</span>
                <button id="login-btn">üîê Login Microsoft</button>
            </div>
            <div class="metric">
                <span class="metric-label">üìä L√≠neas de Producci√≥n:</span>
                <span class="metric-value good">3 L√≠neas Activas</span>
            </div>
            <div class="metric">
                <span class="metric-label">üöÄ Producci√≥n Total:</span>
                <span class="metric-value good" id="production">95.2%</span>
            </div>
            <div class="metric">
                <span class="metric-label">‚ö° Eficiencia Global:</span>
                <span class="metric-value good" id="efficiency">93.8%</span>
            </div>
            <div class="metric">
                <span class="metric-label">ü§ñ M√°quinas Online:</span>
                <span class="metric-value good" id="machines-status">9/9 Conectadas</span>
            </div>
            <div class="metric">
                <span class="metric-label">üîÆ ML Status:</span>
                <span class="metric-value good" id="ml-status">Azure ML Conectado</span>
            </div>
            <div class="metric">
                <span class="metric-label">üå°Ô∏è Max Temperature:</span>
                <span class="metric-value" id="temperature">72¬∞C</span>
            </div>
        </div>
        
        <div id="azure-status">
            <div class="connection-info">
                <span class="azure-indicator online"></span>
                <div class="status-details">
                    <strong>üîó Azure ML APIs: Conectado</strong>
                    <small>‚úÖ 4 Modelos ML Activos (99%+ precisi√≥n)</small>
                    <small>üì° Updates cada 10 segundos</small>
                    <small>üîÑ <span id="last-update">Actualizando...</span></small>
                </div>
            </div>
        </div>
        
        <div id="controls">
            <button class="control-btn active" onclick="resetCamera()">üìπ Reset View</button>
            <button class="control-btn" onclick="toggleAnimation()">üé¨ Animation</button>
            <button class="control-btn" onclick="showFactoryInfo()">‚ÑπÔ∏è Factory Info</button>
        </div>
        
        <div id="factory-explanation" class="factory-explanation">
            <h3>üè≠ Estructura de la F√°brica</h3>
            <p><strong>3 L√≠neas de Producci√≥n:</strong></p>
            <ul>
                <li>üìç <strong>L√≠nea 1:</strong> CNC_01 ‚Üí ROBOT_01 ‚Üí CONV_01</li>
                <li>üìç <strong>L√≠nea 2:</strong> CNC_02 ‚Üí ROBOT_02 ‚Üí CONV_02</li>
                <li>üìç <strong>L√≠nea 3:</strong> CNC_03 ‚Üí ROBOT_03 ‚Üí CONV_03</li>
            </ul>
            <br>
            <p><strong>üîó "Conectado" significa:</strong></p>
            <ul>
                <li>‚úÖ Azure ML APIs funcionando (4 modelos)</li>
                <li>‚úÖ Datos en tiempo real cada 10 segundos</li>
                <li>‚úÖ Predicciones ML: Mantenimiento, Calidad, Energ√≠a, Anomal√≠as</li>
                <li>‚úÖ Confidence realista 65-95% (no 100% irreal)</li>
            </ul>
            <button onclick="hideFactoryInfo()">Cerrar</button>
        </div>
    </div>

    <script>
        // Azure ML Configuration
        const AZURE_ML_CONFIG = {
            endpoint: 'https://smartfactory-ml-api.azurewebsites.net',
            useRealModels: true,
            fallbackEnabled: true,
            retryAttempts: 3
        };

        // Microsoft Authentication Configuration
        const msalConfig = {
            auth: {
                clientId: "12345678-1234-1234-1234-123456789012", // Replace with real App Registration ID
                authority: "https://login.microsoftonline.com/common",
                redirectUri: window.location.origin
            },
            cache: {
                cacheLocation: "sessionStorage",
                storeAuthStateInCookie: false
            }
        };

        let msalInstance, currentUser = null;
        let scene, camera, renderer, machines = {};

        // Initialize Microsoft Authentication
        async function initializeAuthentication() {
            try {
                msalInstance = new msal.PublicClientApplication(msalConfig);
                await msalInstance.initialize();
                
                const accounts = msalInstance.getAllAccounts();
                if (accounts.length > 0) {
                    currentUser = accounts[0];
                    updateUserInfo();
                }
                
                document.getElementById('login-btn').addEventListener('click', async () => {
                    if (currentUser) {
                        await msalInstance.logoutRedirect();
                    } else {
                        try {
                            const loginResponse = await msalInstance.loginPopup({
                                scopes: ['user.read'],
                                prompt: 'select_account'
                            });
                            currentUser = loginResponse.account;
                            updateUserInfo();
                        } catch (error) {
                            console.warn('Login failed:', error);
                        }
                    }
                });
            } catch (error) {
                console.warn('Authentication not available:', error);
            }
        }
        
        function updateUserInfo() {
            const userNameEl = document.getElementById('user-name');
            const loginBtnEl = document.getElementById('login-btn');
            
            if (currentUser) {
                userNameEl.textContent = currentUser.name || currentUser.username;
                loginBtnEl.textContent = 'üö™ Logout';
            } else {
                userNameEl.textContent = 'Invitado';
                loginBtnEl.textContent = 'üîê Login Microsoft';
            }
        }

        // Enhanced fetch with retry logic
        async function fetchWithRetry(url, options = {}, retries = 3) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, {
                        ...options,
                        timeout: 10000
                    });
                    
                    if (response.ok) {
                        return await response.json();
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                } catch (error) {
                    console.warn(`Attempt ${i + 1} failed:`, error.message);
                    if (i === retries - 1) throw error;
                    await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1)));
                }
            }
        }

        // Initialize 3D Scene
        function init() {
            // Scene setup
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0c1326);
            
            // Camera
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 15, 25);
            camera.lookAt(0, 0, 0);
            
            // Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            document.getElementById('threejs-container').appendChild(renderer.domElement);
            
            // Lighting
            setupLighting();
            
            // Factory Environment
            createFactoryEnvironment();
            
            // Create 3 Production Lines
            createMachines();
            
            // Start animation loop
            animate();
            
            // Start real-time updates
            startRealTimeUpdates();
        }
        
        function setupLighting() {
            const ambientLight = new THREE.AmbientLight(0x404040, 0.3);
            scene.add(ambientLight);
            
            const mainLight = new THREE.DirectionalLight(0xffffff, 0.8);
            mainLight.position.set(20, 30, 20);
            mainLight.castShadow = true;
            scene.add(mainLight);
        }
        
        function createFactoryEnvironment() {
            // Factory floor
            const floorGeometry = new THREE.PlaneGeometry(40, 35);
            const floorMaterial = new THREE.MeshStandardMaterial({
                color: 0x2a2a2a,
                roughness: 0.8
            });
            const floor = new THREE.Mesh(floorGeometry, floorMaterial);
            floor.rotation.x = -Math.PI / 2;
            floor.position.y = -1.5;
            floor.receiveShadow = true;
            scene.add(floor);
        }
        
        function createMachines() {
            // 3 Production Lines with 3 machines each
            const machineConfigs = [
                // LINE 1
                { id: 'LINE_1_CNC_01', name: 'üîß CNC 01', line: 1, type: 'CNC', pos: [-12, 0, -8], color: 0x2ecc71 },
                { id: 'LINE_1_ROBOT_01', name: 'ü§ñ ROBOT 01', line: 1, type: 'ROBOT', pos: [0, 0, -8], color: 0x3498db },
                { id: 'LINE_1_CONV_01', name: 'üì¶ CONV 01', line: 1, type: 'CONV', pos: [12, 0, -8], color: 0x9b59b6 },
                
                // LINE 2  
                { id: 'LINE_2_CNC_02', name: 'üîß CNC 02', line: 2, type: 'CNC', pos: [-12, 0, 0], color: 0x27ae60 },
                { id: 'LINE_2_ROBOT_02', name: 'ü§ñ ROBOT 02', line: 2, type: 'ROBOT', pos: [0, 0, 0], color: 0x2980b9 },
                { id: 'LINE_2_CONV_02', name: 'üì¶ CONV 02', line: 2, type: 'CONV', pos: [12, 0, 0], color: 0x8e44ad },
                
                // LINE 3
                { id: 'LINE_3_CNC_03', name: 'üîß CNC 03', line: 3, type: 'CNC', pos: [-12, 0, 8], color: 0x1e8449 },
                { id: 'LINE_3_ROBOT_03', name: 'ü§ñ ROBOT 03', line: 3, type: 'ROBOT', pos: [0, 0, 8], color: 0x1f4e79 },
                { id: 'LINE_3_CONV_03', name: 'üì¶ CONV 03', line: 3, type: 'CONV', pos: [12, 0, 8], color: 0x6c3483 }
            ];
            
            machineConfigs.forEach(config => createMachine(config));
            createProductionLines();
        }
        
        function createMachine(config) {
            const group = new THREE.Group();
            
            // Main body
            const body = new THREE.Mesh(
                new THREE.BoxGeometry(4, 3, 3),
                new THREE.MeshStandardMaterial({ color: config.color, metalness: 0.7, roughness: 0.3 })
            );
            body.position.y = 1.5;
            body.castShadow = true;
            group.add(body);
            
            // Base
            const base = new THREE.Mesh(
                new THREE.BoxGeometry(4.5, 0.5, 3.5),
                new THREE.MeshStandardMaterial({ color: 0x34495e, metalness: 0.8 })
            );
            base.position.y = -1.25;
            base.castShadow = true;
            group.add(base);
            
            // Status indicator
            const indicator = new THREE.Mesh(
                new THREE.SphereGeometry(0.3, 16, 8),
                new THREE.MeshBasicMaterial({ color: 0x00ff00 })
            );
            indicator.position.set(0, 3.5, 1.5);
            group.add(indicator);
            
            // Machine label
            if (config.name) {
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.width = 512;
                canvas.height = 128;
                
                context.fillStyle = 'rgba(0, 0, 0, 0.8)';
                context.fillRect(0, 0, canvas.width, canvas.height);
                
                context.font = '48px Arial';
                context.fillStyle = 'white';
                context.textAlign = 'center';
                context.fillText(config.name, canvas.width / 2, canvas.height / 2 + 8);
                
                const texture = new THREE.CanvasTexture(canvas);
                const label = new THREE.Sprite(new THREE.SpriteMaterial({ map: texture }));
                label.position.set(0, 6, 0);
                label.scale.set(6, 1.5, 1);
                group.add(label);
            }
            
            // Position
            group.position.set(...config.pos);
            group.userData = { type: 'machine', config };
            
            machines[config.id] = group;
            scene.add(group);
        }
        
        function createProductionLines() {
            const lineMaterial = new THREE.LineBasicMaterial({ 
                color: 0xffffff, 
                transparent: true, 
                opacity: 0.3 
            });
            
            // Create connecting lines for each production line
            for (let line = 1; line <= 3; line++) {
                const y = (line - 2) * 8; // -8, 0, 8
                const points = [
                    new THREE.Vector3(-12, 2, y),
                    new THREE.Vector3(0, 2, y),
                    new THREE.Vector3(12, 2, y)
                ];
                
                const geometry = new THREE.BufferGeometry().setFromPoints(points);
                const lineObj = new THREE.Line(geometry, lineMaterial);
                scene.add(lineObj);
            }
        }
        
        // Real-time updates
        function startRealTimeUpdates() {
            setInterval(() => {
                updateMachineDataFromAzure();
            }, 10000);
            
            updateMachineDataFromAzure();
        }
        
        async function updateMachineDataFromAzure() {
            console.log('üîÑ Updating machine data from Azure ML APIs...');
            
            const machineIds = [
                'LINE_1_CNC_01', 'LINE_1_ROBOT_01', 'LINE_1_CONV_01',
                'LINE_2_CNC_02', 'LINE_2_ROBOT_02', 'LINE_2_CONV_02', 
                'LINE_3_CNC_03', 'LINE_3_ROBOT_03', 'LINE_3_CONV_03'
            ];
            
            let totalProduction = 0;
            let totalEfficiency = 0;
            let maxTemp = 0;
            let activeMachines = 0;
            
            for (const machineId of machineIds) {
                try {
                    const [maintenanceData, qualityData, energyData, anomalyData] = await Promise.all([
                        fetchWithRetry(`${AZURE_ML_CONFIG.endpoint}/api/ml/maintenance?deviceId=${machineId}&real=true&temperature=${70 + Math.random() * 10}&vibration=${0.3 + Math.random() * 0.4}`),
                        fetchWithRetry(`${AZURE_ML_CONFIG.endpoint}/api/ml/quality?deviceId=${machineId}&real=true&temperature=${65 + Math.random() * 10}`),
                        fetchWithRetry(`${AZURE_ML_CONFIG.endpoint}/api/ml/energy?deviceId=${machineId}&real=true&powerConsumption=${40 + Math.random() * 20}`),
                        fetchWithRetry(`${AZURE_ML_CONFIG.endpoint}/api/ml/anomaly?deviceId=${machineId}&real=true&temperature=${70 + Math.random() * 10}&vibration=${0.3 + Math.random() * 0.4}`)
                    ]);
                    
                    updateMachineIndicator(machineId, {
                        maintenance: maintenanceData,
                        quality: qualityData,
                        energy: energyData,
                        anomaly: anomalyData
                    });
                    
                    if (!anomalyData?.IsAnomaly && !anomalyData?.isAnomaly) {
                        totalProduction += qualityData?.QualityScore || qualityData?.qualityScore || 85;
                        totalEfficiency += energyData?.CurrentEfficiency || energyData?.currentEfficiency || 80;
                        maxTemp = Math.max(maxTemp, 75);
                        activeMachines++;
                    }
                    
                } catch (error) {
                    console.warn(`‚ö†Ô∏è Failed to update ${machineId}:`, error.message);
                }
                
                await new Promise(resolve => setTimeout(resolve, 200));
            }
            
            // Update dashboard metrics
            if (activeMachines > 0) {
                document.getElementById('production').textContent = (totalProduction / activeMachines).toFixed(1) + '%';
                document.getElementById('efficiency').textContent = (totalEfficiency / activeMachines).toFixed(1) + '%';
                document.getElementById('temperature').textContent = maxTemp.toFixed(0) + '¬∞C';
                document.getElementById('machines-status').textContent = `${activeMachines}/9 Conectadas`;
            }
            
            updateAzureStatus();
        }
        
        function updateMachineIndicator(machineId, data) {
            const machine = machines[machineId];
            if (!machine) return;
            
            const indicator = machine.children.find(child => 
                child.material && child.material.color
            );
            
            if (indicator) {
                if (data?.anomaly?.IsAnomaly || data?.anomaly?.isAnomaly) {
                    indicator.material.color.setHex(0xff0000); // Red for anomaly
                } else if (data?.maintenance?.Prediction === 'maintenance_required') {
                    indicator.material.color.setHex(0xffa500); // Orange for maintenance
                } else {
                    indicator.material.color.setHex(0x00ff00); // Green for normal
                }
            }
        }
        
        function updateAzureStatus() {
            const now = new Date();
            document.getElementById('last-update').textContent = now.toLocaleTimeString();
        }
        
        // Animation loop
        function animate() {
            requestAnimationFrame(animate);
            
            // Rotate machines slightly for visual interest
            Object.values(machines).forEach(machine => {
                machine.rotation.y += 0.005;
            });
            
            renderer.render(scene, camera);
        }
        
        // Controls
        function resetCamera() {
            camera.position.set(0, 15, 25);
            camera.lookAt(0, 0, 0);
        }
        
        function toggleAnimation() {
            console.log('Animation toggled');
        }
        
        function showFactoryInfo() {
            document.getElementById('factory-explanation').style.display = 'block';
        }
        
        function hideFactoryInfo() {
            document.getElementById('factory-explanation').style.display = 'none';
        }
        
        // Handle window resize
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
        
        // Initialize everything
        window.addEventListener('load', () => {
            initializeAuthentication();
            init();
            
            setTimeout(() => {
                document.getElementById('loading').style.display = 'none';
            }, 3000);
        });
    </script>
</body>
</html>