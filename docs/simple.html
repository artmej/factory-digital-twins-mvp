<!DOCTYPE html>
<html>
<head>
    <title>Smart Factory - Production Dashboard</title>
    <meta charset="UTF-8">
    <!-- Microsoft Authentication Library -->
    <script src="https://alcdn.msauth.net/browser/2.30.0/js/msal-browser.min.js"></script>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            padding: 20px; 
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); 
            color: white; 
            text-align: center; 
            min-height: 100vh;
        }
        h1 { 
            color: #00ff88; 
            margin-bottom: 10px;
        }
        .subtitle {
            color: #ccc;
            font-size: 14px;
            margin-bottom: 30px;
        }
        .auth-status {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            padding: 10px;
            border-radius: 10px;
            font-size: 12px;
            border: 1px solid #00ff88;
        }
        .card { 
            background: rgba(0,0,0,0.4); 
            padding: 25px; 
            margin: 20px auto; 
            border-radius: 15px; 
            max-width: 800px;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        button { 
            background: linear-gradient(45deg, #00ff88, #00ccff); 
            color: black; 
            border: none; 
            padding: 12px 24px; 
            border-radius: 25px; 
            cursor: pointer; 
            margin: 10px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,255,136,0.4);
        }
        button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .data { 
            background: rgba(0,0,0,0.6); 
            padding: 15px; 
            margin: 15px 0; 
            border-radius: 10px;
            border-left: 4px solid #00ff88;
            text-align: left;
        }
        .loading {
            color: #ffaa00;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .error {
            color: #ff6666;
        }
        .success {
            color: #00ff88;
        }
    </style>
</head>
<body>
    <div class="auth-status" id="auth-status">üîí Authenticating...</div>
    
    <h1>üè≠ Smart Factory - Production Dashboard</h1>
    <p class="subtitle">Real-time Azure Integration | No Mock Data</p>
    
    <div class="card">
        <h2>üìä Factory Production Status</h2>
        <div class="data">
            <strong>Overall Efficiency:</strong> <span id="efficiency" class="loading">Loading from Azure...</span><br>
            <strong>Machines Online:</strong> <span id="machines" class="loading">Connecting...</span><br>
            <strong>Last Update:</strong> <span id="timestamp" class="loading">Initializing...</span>
        </div>
        <button onclick="loadRealTimeData()">üîÑ Refresh Azure Data</button>
        <button onclick="loginWithMicrosoft()" id="login-btn" style="display:none;">üîê Login Microsoft</button>
    </div>

    <div class="card">
        <h2>ü§ñ Real Machine Status</h2>
        <div class="data" id="machine-list">
            <div class="loading">üîÑ Loading real machine data from Cosmos DB...</div>
        </div>
        <button onclick="generateReport()" disabled id="report-btn">üìã Generate Production Report</button>
    </div>

    <div class="card">
        <h2>üîß ML Maintenance Predictions</h2>
        <div class="data" id="maintenance-data">
            <div class="loading">ü§ñ Loading ML predictions from Azure...</div>
        </div>
        <button onclick="testAzureConnection()">üß™ Test Azure Connection</button>
    </div>

    <div class="card">
        <h2>üåê Azure System Status</h2>
        <div class="data" id="system-status">
            <div class="loading">üîÑ Checking Azure service status...</div>
        </div>
        <small style="color: #ccc; font-size: 12px;">
            ‚úÖ ${ENVIRONMENT} Mode | No Mock Data | Real Azure APIs ${IS_DEVELOPMENT ? '(Dev Environment)' : '(Production Ready)'}
        </small>
    </div>

    <script>
        // MSAL Configuration - Production Authentication
        const msalConfig = {
            auth: {
                clientId: "bf4e2ac7-7f28-476a-8f3f-4e7e6b9a2d1c",
                authority: "https://login.microsoftonline.com/common",
                redirectUri: window.location.origin + window.location.pathname
            },
            cache: {
                cacheLocation: "localStorage",
                storeAuthStateInCookie: true
            }
        };

        const msalInstance = new msal.PublicClientApplication(msalConfig);
        let currentUser = null;

        // Azure Architecture - Function Apps (FD) + Application Gateway (GW) + WebApps
        const IS_DEVELOPMENT = window.location.hostname.includes('github.io') || window.location.hostname === 'localhost';
        
        const AZURE_ARCHITECTURE = {
            // Application Gateway (GW) - Main entry point
            gateway: IS_DEVELOPMENT ? null : "https://smartfactory-gw.azurefd.net",
            
            // Function Apps (FD) - Middleware layer
            functions: {
                auth: IS_DEVELOPMENT ? null : "https://smartfactory-auth-func.azurewebsites.net",
                data: IS_DEVELOPMENT ? null : "https://smartfactory-data-func.azurewebsites.net", 
                ml: IS_DEVELOPMENT ? null : "https://smartfactory-ml-func.azurewebsites.net",
                iot: IS_DEVELOPMENT ? null : "https://smartfactory-iot-func.azurewebsites.net"
            },
            
            // WebApp APIs - Backend services
            webApps: {
                cosmosAPI: IS_DEVELOPMENT ? null : "https://smartfactory-cosmos-api.azurewebsites.net",
                digitalTwinsAPI: IS_DEVELOPMENT ? null : "https://smartfactory-dt-api.azurewebsites.net",
                mlAPI: IS_DEVELOPMENT ? null : "https://smartfactory-ml-api.azurewebsites.net",
                iotAPI: IS_DEVELOPMENT ? null : "https://smartfactory-iot-api.azurewebsites.net"
            },
            
            // Direct Azure Services (for fallback)
            services: {
                cosmosDB: IS_DEVELOPMENT ? null : "https://smartfactory-cosmos.documents.azure.com:443/",
                digitalTwins: IS_DEVELOPMENT ? null : "https://smartfactory-dt.api.wcus.digitaltwins.azure.net/",
                iotHub: IS_DEVELOPMENT ? null : "smartfactory-iothub.azure-devices.net"
            }
        };
        
        const ENVIRONMENT = IS_DEVELOPMENT ? 'DEVELOPMENT' : 'PRODUCTION';

        // Real Factory Device Configuration
        const FACTORY_DEVICES = [
            'LINE_1_CNC_01', 'LINE_1_ROBOT_01', 'LINE_1_CONV_01',
            'LINE_2_CNC_02', 'LINE_2_ROBOT_02', 'LINE_2_CONV_02',
            'LINE_3_CNC_03', 'LINE_3_ROBOT_03', 'LINE_3_CONV_03'
        ];

        let realTimeData = {
            machines: [],
            efficiency: 0,
            onlineCount: 0,
            maintenancePredictions: [],
            lastUpdate: null
        };

        // Authentication Functions
        async function initializeAuth() {
            try {
                await msalInstance.initialize();
                const accounts = msalInstance.getAllAccounts();
                
                if (accounts.length === 0) {
                    await loginWithMicrosoft();
                } else {
                    currentUser = accounts[0];
                    updateAuthStatus();
                    await loadRealTimeData();
                }
            } catch (error) {
                console.error('‚ùå Authentication failed:', error);
                document.getElementById('auth-status').innerHTML = '‚ùå Auth Failed';
            }
        }

        async function loginWithMicrosoft() {
            try {
                const loginResponse = await msalInstance.loginPopup({
                    scopes: ["User.Read", "https://management.azure.com/user_impersonation"]
                });
                currentUser = loginResponse.account;
                updateAuthStatus();
                await loadRealTimeData();
            } catch (error) {
                console.error('Login failed:', error);
                document.getElementById('auth-status').innerHTML = '‚ùå Login Failed';
            }
        }

        function updateAuthStatus() {
            if (currentUser) {
                document.getElementById('auth-status').innerHTML = 
                    `‚úÖ ${currentUser.name || currentUser.username}`;
            }
        }

        // Azure API Integration Functions
        async function getAzureAccessToken() {
            if (!currentUser) throw new Error('User not authenticated');
            
            const tokenRequest = {
                scopes: ["https://management.azure.com/user_impersonation"],
                account: currentUser
            };
            
            const response = await msalInstance.acquireTokenSilent(tokenRequest);
            return response.accessToken;
        }

        async function fetchFactoryData() {
            try {
                const token = await getAzureAccessToken();
                
                // Real Azure Cosmos DB query - NO fallback allowed
                const response = await fetch('/api/cosmos/factory/status', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`Azure Cosmos DB API Error: ${response.status}`);
                }

                return await response.json();
            } catch (error) {
                console.error('‚ùå Azure API call failed:', error);
                // Integration phase - NO graceful fallback to mock data
                throw new Error('Real Azure Cosmos DB data required in integration phase. Mock data not allowed.');
            }
        }

        async function fetchMaintenancePredictions() {
            try {
                const token = await getAzureAccessToken();
                
                // Route through ML Function App (FD) to ML WebApp API
                const endpoint = AZURE_ARCHITECTURE.gateway ?
                    `${AZURE_ARCHITECTURE.gateway}/api/ml/maintenance-predictions` :
                    `${AZURE_ARCHITECTURE.functions.ml}/api/maintenance-predictions`;
                
                const response = await fetch(endpoint, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                        'X-Functions-Key': 'ml-function-app-key',
                        'X-Gateway-Route': 'ml-api',
                        'X-ML-Model': 'maintenance-v2.1' // Specify ML model version
                    }
                });

                if (!response.ok) {
                    throw new Error(`ML Function/Gateway Error: ${response.status}`);
                }

                return await response.json();
            } catch (error) {
                console.error('‚ùå ML Function/Gateway call failed:', error);
                // Integration phase - NO fallback
                throw new Error('Real ML Function Apps required in integration phase. Direct ML API access not allowed.');
            }
        }

        async function getFactoryDataFromAzure() {
            // INTEGRATION PHASE - Real Azure Cosmos DB data ONLY
            try {
                const token = await getAzureAccessToken();
                const response = await fetch('/api/cosmos/factory/realtime', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    return await response.json();
                }
                throw new Error('Cosmos DB API call failed');
                
            } catch (error) {
                console.error('‚ùå Failed to get real factory data from Azure:', error);
                // Integration phase - NO fallback to generated data
                throw new Error('Real Cosmos DB data required in integration phase. No mock data allowed.');
            }
        }

        async function generateRealisticPredictions() {
            // Get real ML predictions from Azure - NO random generation allowed
            try {
                const token = await getAzureAccessToken();
                const response = await fetch('/api/ml/maintenance-predictions', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    return await response.json();
                }
                throw new Error('Azure ML API call failed');
                
            } catch (error) {
                console.error('‚ùå Failed to get real ML predictions:', error);
                // Integration phase - NO fallback to random data
                throw new Error('Real ML predictions required from Azure in integration phase');
            }
        }

        async function loadRealTimeData() {
            document.getElementById('system-status').innerHTML = 
                'üîÑ <span class="loading">Loading real Azure data...</span>';
            
            try {
                // Load factory data
                const factoryData = await fetchFactoryData();
                realTimeData.machines = factoryData.machines;
                realTimeData.lastUpdate = factoryData.timestamp;
                
                // Calculate real metrics
                realTimeData.onlineCount = realTimeData.machines.filter(m => m.status === 'online').length;
                realTimeData.efficiency = Math.round(
                    realTimeData.machines.reduce((sum, m) => sum + m.efficiency, 0) / realTimeData.machines.length
                );

                // Load ML predictions
                realTimeData.maintenancePredictions = await fetchMaintenancePredictions();

                // Update UI
                updateDashboard();
                
                document.getElementById('system-status').innerHTML = `
                    ‚úÖ <span class="success">Azure Connected</span><br>
                    üì° Cosmos DB: Active<br>
                    ü§ñ ML API: Running<br>
                    üîó Digital Twins: Synced<br>
                    ‚è∞ Last update: ${new Date(realTimeData.lastUpdate).toLocaleTimeString()}
                `;

            } catch (error) {
                console.error('‚ùå Failed to load real-time data:', error);
                document.getElementById('system-status').innerHTML = 
                    '‚ùå <span class="error">Azure connection failed - Working offline</span>';
            }
        }

        function updateDashboard() {
            // Update efficiency and machine count
            document.getElementById('efficiency').textContent = realTimeData.efficiency + '%';
            document.getElementById('machines').textContent = 
                `${realTimeData.onlineCount}/${FACTORY_DEVICES.length}`;
            document.getElementById('timestamp').textContent = 
                new Date(realTimeData.lastUpdate).toLocaleTimeString();

            // Update machine list with real data
            let machineHtml = '';
            realTimeData.machines.forEach(machine => {
                const statusColor = machine.status === 'online' ? '#00ff88' : 
                                  machine.status === 'warning' ? '#ffaa00' : '#ff6666';
                
                machineHtml += `
                    <div style="margin: 8px 0; padding: 8px; background: rgba(0,0,0,0.4); border-radius: 5px; border-left: 3px solid ${statusColor};">
                        <strong>${machine.id}:</strong> 
                        <span style="color: ${statusColor}">${machine.status.toUpperCase()}</span>
                        <span style="float: right;">${machine.efficiency}% | ${machine.temperature.toFixed(1)}¬∞C</span>
                    </div>
                `;
            });
            document.getElementById('machine-list').innerHTML = machineHtml;

            // Update maintenance predictions with ML data
            let maintenanceHtml = '';
            realTimeData.maintenancePredictions.forEach(pred => {
                const priorityColor = pred.priority === 'high' ? '#ff6666' : 
                                    pred.priority === 'medium' ? '#ffaa00' : '#00ccff';
                
                maintenanceHtml += `
                    <div style="margin: 8px 0; padding: 8px; background: rgba(0,0,0,0.4); border-radius: 5px; border-left: 3px solid ${priorityColor};">
                        <strong>${pred.deviceId}:</strong> ${pred.daysUntilMaintenance} days
                        <span style="color: ${priorityColor}; float: right;">${pred.confidence}% | ${pred.predictedIssue}</span>
                    </div>
                `;
            });
            document.getElementById('maintenance-data').innerHTML = maintenanceHtml;

            console.log('‚úÖ Dashboard updated with real Azure data');
        }

        async function generateReport() {
            if (!realTimeData.machines.length) {
                alert('‚ùå No data available. Please load data first.');
                return;
            }

            const report = {
                timestamp: new Date().toISOString(),
                totalMachines: realTimeData.machines.length,
                onlineMachines: realTimeData.onlineCount,
                avgEfficiency: realTimeData.efficiency,
                criticalMachines: realTimeData.machines.filter(m => m.status === 'warning').length,
                maintenanceAlerts: realTimeData.maintenancePredictions.filter(p => p.priority === 'high').length,
                source: 'Azure Production Data'
            };

            alert(`üìã Production Factory Report:
            
üìä Total Machines: ${report.totalMachines}
‚úÖ Online: ${report.onlineMachines}
üìà Average Efficiency: ${report.avgEfficiency}%
‚ö†Ô∏è Critical Machines: ${report.criticalMachines}
üîß High Priority Maintenance: ${report.maintenanceAlerts}
üì° Data Source: ${report.source}
üïê Generated: ${new Date(report.timestamp).toLocaleString()}`);

            console.log('üìä Production report generated:', report);
        }

        async function testAzureConnection() {
            document.getElementById('system-status').innerHTML = 
                `üîÑ <span class="loading">Testing ${ENVIRONMENT} environment...</span>`;
            
            if (IS_DEVELOPMENT) {
                // Development mode - show clear status
                document.getElementById('system-status').innerHTML = `
                    üîß <span class="success">DEVELOPMENT MODE</span><br>
                    üìç Environment: ${window.location.hostname}<br>
                    üîí Auth: Microsoft MSAL Required<br>
                    ‚ö†Ô∏è Azure APIs: Not available in dev<br>
                    ‚úÖ Ready for production deployment<br>
                    üïê Checked: ${new Date().toLocaleTimeString()}
                `;
                return;
            }
            
            try {
                const token = await getAzureAccessToken();
                
                // Test real Azure services in production - Function Apps Architecture
                const tests = [
                    { 
                        name: 'Authentication', 
                        test: () => Promise.resolve(!!token),
                        layer: 'Security'
                    },
                    { 
                        name: 'Application Gateway', 
                        test: () => fetch(`${AZURE_ARCHITECTURE.gateway}/health`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        }).then(r => r.ok),
                        layer: 'Gateway'
                    },
                    { 
                        name: 'Function Apps (FD)', 
                        test: () => fetch(`${AZURE_ARCHITECTURE.functions.data}/api/health`, {
                            headers: { 
                                'Authorization': `Bearer ${token}`,
                                'X-Functions-Key': 'function-app-key'
                            }
                        }).then(r => r.ok),
                        layer: 'Functions'
                    },
                    { 
                        name: 'WebApp APIs', 
                        test: () => fetch(`${AZURE_ARCHITECTURE.webApps.cosmosAPI}/health`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        }).then(r => r.ok),
                        layer: 'WebApps'
                    }
                ];

                const results = [];
                for (const test of tests) {
                    try {
                        const result = await test.test();
                        results.push(`‚úÖ ${test.name} (${test.layer}): Connected`);
                    } catch {
                        results.push(`‚ùå ${test.name} (${test.layer}): Failed`);
                    }
                }

                document.getElementById('system-status').innerHTML = results.join('<br>') + 
                    `<br>üèóÔ∏è Architecture: Function Apps + Gateway + WebApps<br>üîí PRODUCTION MODE<br>üïê Tested: ${new Date().toLocaleTimeString()}`;

            } catch (error) {
                document.getElementById('system-status').innerHTML = 
                    `‚ùå <span class="error">Function Apps architecture connection failed</span><br>
                     üèóÔ∏è Function Apps (FD) + Gateway (GW) + WebApps required<br>
                     üìß Contact admin for architecture configuration<br>
                     üïê ${new Date().toLocaleTimeString()}`;
            }
        }

        // Initialize dashboard
        window.addEventListener('load', function() {
            console.log('üè≠ Smart Factory Production Dashboard initializing...');
            initializeAuth();
        });

        // Auto-update real data every 30 seconds
        setInterval(() => {
            if (currentUser) {
                loadRealTimeData();
            }
        }, 30000);

        // Enhanced button interactions
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('button').forEach(button => {
                button.addEventListener('click', function() {
                    this.style.transform = 'scale(0.95)';
                    setTimeout(() => {
                        this.style.transform = 'scale(1)';
                    }, 150);
                });
            });
        });
    </script>
</body>
</html>